import{r as T,f as ee,u as le,j as e,d as Z,m as re,c as oe,n as ce,a as de,p as ue}from"./index-EMt5RE97.js";import{S as K}from"./skeleton-Cp1WkSdd.js";import{m as he}from"./proxy-aKQDG_aa.js";const pe="_wrapper_1lbh8_1",fe="_title_1lbh8_9",xe="_grid_1lbh8_16",me="_infoCard_1lbh8_23",be="_chartCard_1lbh8_23",ge="_aboutCard_1lbh8_23",je="_table_1lbh8_31",Te="_subhead_1lbh8_42",ye="_chartPlaceholder_1lbh8_52",ve="_fvCard_1lbh8_64",we="_fvHeader_1lbh8_65",Me="_fvTitle_1lbh8_66",Ne="_fvGrid_1lbh8_68",Ce="_kpi_1lbh8_69",ke="_kpiTitle_1lbh8_70",Se="_kpiValue_1lbh8_71",Pe="_kpiSub_1lbh8_72",Ee="_muted_1lbh8_74",_e="_rawBlock_1lbh8_77",Ae="_rawSummary_1lbh8_81",$e="_rawTableWrap_1lbh8_91",Be="_metricsTable_1lbh8_99",De="_keyCell_1lbh8_119",Ie="_valCell_1lbh8_125",Fe="_errorText_1lbh8_131",i={wrapper:pe,title:fe,grid:xe,infoCard:me,chartCard:be,aboutCard:ge,table:je,subhead:Te,chartPlaceholder:ye,fvCard:ve,fvHeader:we,fvTitle:Me,fvGrid:Ne,kpi:Ce,kpiTitle:ke,kpiValue:Se,kpiSub:Pe,muted:Ee,rawBlock:_e,rawSummary:Ae,rawTableWrap:$e,metricsTable:Be,keyCell:De,valCell:Ie,errorText:Fe};function Ue(t){const[n,c]=T.useState(!0),[l,r]=T.useState(null),[x,a]=T.useState(null);return T.useEffect(()=>{let p=!1;async function j(){if(t){c(!0),r(null);try{const s=await ee(`/api/fh/metrics?symbol=${encodeURIComponent(t)}`,{noStore:!0,timeoutMs:2e4});p||a((s==null?void 0:s.metric)??{})}catch(s){p||r(String((s==null?void 0:s.message)||s))}finally{p||c(!1)}}}return j(),()=>{p=!0}},[t]),{loading:n,error:l,metric:x}}function Ge(t){const[n,c]=T.useState(!0),[l,r]=T.useState(null),[x,a]=T.useState(null);return T.useEffect(()=>{let p=!1;async function j(){if(t){c(!0),r(null);try{const s=await ee(`/api/fh/profile2?symbol=${encodeURIComponent(t)}`,{noStore:!0,timeoutMs:15e3});p||a((s==null?void 0:s.profile)??null)}catch(s){p||r(String((s==null?void 0:s.message)||s))}finally{p||c(!1)}}}return j(),()=>{p=!0}},[t]),{loading:n,error:l,profile:x}}function Oe(t){const[n,c]=T.useState(!0),[l,r]=T.useState(null),[x,a]=T.useState(null);return T.useEffect(()=>{let p=!1;async function j(){if(t){c(!0),r(null);try{const s=await ee(`/api/sec/company-facts?symbol=${encodeURIComponent(t)}`,{noStore:!0,timeoutMs:2e4});p||a(s??null)}catch(s){p||r(String((s==null?void 0:s.message)||s))}finally{p||c(!1)}}}return j(),()=>{p=!0}},[t]),{loading:n,error:l,facts:x}}function O(t){return typeof t!="number"||!Number.isFinite(t)?"—":Math.abs(t)>=1e12?(t/1e12).toFixed(2)+"T":Math.abs(t)>=1e9?(t/1e9).toFixed(2)+"B":Math.abs(t)>=1e6?(t/1e6).toFixed(2)+"M":Math.abs(t)>=1e3?(t/1e3).toFixed(2)+"K":t.toFixed(2)}function U(t){const n=typeof t=="number"?t:Number(t);return Number.isFinite(n)?Math.abs(n)>=100?n.toFixed(0):n.toFixed(2):String(t??"—")}function G(t,n){if(!t)return null;for(const c of n){const l=t[c];if(typeof l=="number"&&Number.isFinite(l))return l}return null}function Re(t){if(!t)return"—";const n=String(t).toLowerCase();return n.charAt(0).toUpperCase()+n.slice(1)}const Ve=({symbol:t,priceSeed:n,categorySeed:c,metric:l,metricsLoading:r,metricsError:x,p2:a,p2Loading:p,p2Error:j,secFacts:s,secError:v})=>{var u,_,E,b,N;const{t:o}=le(),h=T.useMemo(()=>{const d=l||{},g=G(d,["peTTM","peInclExtraTTM","peExclExtraTTM","peAnnual","peBasicExclExtraTTM"]),y=G(d,["psTTM","psAnnual"]),I=G(d,["pb","priceToBookAnnual"]),D=G(d,["pegAnnual","pegRatio"]),M=G(d,["enterpriseValueOverEBITDA","evebitdaAnnual"]),F=G(d,["roeTTM","roeAnnual"]),L=G(d,["roicTTM","roicAnnual"]),C=G(d,["grossMarginTTM","grossMarginAnnual"]),k=G(d,["netProfitMarginTTM","netMarginAnnual"]),A=G(d,["debtToEquityAnnual","debtToEquityTTM"]),m=G(d,["currentRatioAnnual","currentRatioTTM"]),P=G(d,["marketCapitalization"]),$=G(d,["sharesBasic"]);return{pe:g,ps:y,pb:I,peg:D,evEbitda:M,roe:F,roic:L,grossMargin:C,netMargin:k,dToE:A,currentRatio:m,marketCap:P,shares:$}},[l]),w=T.useMemo(()=>{const d=l||{},g=W=>typeof W=="number"&&Number.isFinite(W)?W:null,y=g(d.marketCapitalization??h.marketCap),I=g(d.enterpriseValue),D=g(d.totalDebt),M=g(d.totalCash??d.totalCashAndEquivalents??(d==null?void 0:d.cashAndEq)),F=g(d.operatingCashFlowTTM??(d==null?void 0:d.operatingCfTTM)),L=g(d.capitalExpenditureTTM??(d==null?void 0:d.capexTTM)),C=g((d==null?void 0:d.pfcfShareTTM)??(d==null?void 0:d.pfcfShareAnnual)),k=typeof n=="number"&&Number.isFinite(n)?n:null,A=g(h.shares)??g(a==null?void 0:a.shareOutstanding);let m=null,P=null;D!=null&&M!=null?(m=D-M,y!=null&&(P=y+m)):I!=null&&y!=null&&(P=I,m=P-y);let $=null;F!=null&&L!=null?$=F-L:k!=null&&C!=null&&C>0&&A!=null&&A>0&&($=k/C*A);const te=$!=null&&y!=null&&y>0?$/y:null,X=$!=null&&$!==0&&P!=null?P/$:null;return{netDebt:m,ev:P,fcf:$,fcfYield:te,evPerFcf:X}},[l,h.marketCap,h.shares,a==null?void 0:a.shareOutstanding,n]),B=(s==null?void 0:s.entityName)||null;return e.jsxs("div",{className:i.infoCard,children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:8},children:[a!=null&&a.logo?e.jsx("img",{src:a.logo,alt:"logo",style:{width:36,height:36,objectFit:"contain"}}):null,e.jsx("h3",{style:{margin:0},children:o("stockDetails.info")})]}),e.jsx("table",{className:i.table,children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("strong",{children:[o("stockDetails.ticker"),":"]})}),e.jsx("td",{children:t})]}),!p&&!a&&B?e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Name:"})}),e.jsx("td",{children:B})]}):null,e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("strong",{children:[o("stockDetails.price"),":"]})}),e.jsx("td",{children:n!=null?`$${U(n)}`:"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("strong",{children:[o("stockDetails.category"),":"]})}),e.jsx("td",{children:c?Re(c):"—"})]}),p?e.jsxs(e.Fragment,{children:[e.jsx("tr",{children:e.jsx("td",{colSpan:2,children:e.jsx(K,{height:12})})}),e.jsx("tr",{children:e.jsx("td",{colSpan:2,children:e.jsx(K,{height:12})})})]}):j?e.jsx("tr",{children:e.jsxs("td",{colSpan:2,className:i.errorText,children:["FH Profile2 error: ",j]})}):a?e.jsxs(e.Fragment,{children:[a.name&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Name:"})}),e.jsx("td",{children:a.name})]}),a.finnhubIndustry&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Industry:"})}),e.jsx("td",{children:a.finnhubIndustry})]}),(a.exchange||a.country)&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Listing:"})}),e.jsx("td",{children:[a.exchange,a.country].filter(Boolean).join(", ")})]}),a.ipo&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"IPO:"})}),e.jsx("td",{children:a.ipo})]}),typeof a.marketCapitalization=="number"&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Market Cap (FH):"})}),e.jsxs("td",{children:["$",O(a.marketCapitalization)]})]}),typeof a.shareOutstanding=="number"&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Shares Out:"})}),e.jsx("td",{children:O(a.shareOutstanding)})]}),a.weburl&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Website:"})}),e.jsx("td",{children:e.jsx("a",{href:a.weburl,target:"_blank",rel:"noreferrer noopener",children:a.weburl})})]})]}):null,v?e.jsx("tr",{children:e.jsxs("td",{colSpan:2,className:i.errorText,children:["SEC error: ",v]})}):s?e.jsxs(e.Fragment,{children:[(s.entityName||s.cik)&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"SEC Entity:"})}),e.jsx("td",{children:[s.entityName,s.cik?`CIK ${s.cik}`:""].filter(Boolean).join(" — ")})]}),((u=s.revenueUsd)==null?void 0:u.v)!=null&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Revenue (US-GAAP):"})}),e.jsxs("td",{children:["$",O(s.revenueUsd.v),s.revenueUsd.asOf?` (as of ${s.revenueUsd.asOf})`:""," [USD]"]})]}),((_=s.netIncomeUsd)==null?void 0:_.v)!=null&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Net Income (US-GAAP):"})}),e.jsxs("td",{children:["$",O(s.netIncomeUsd.v),s.netIncomeUsd.asOf?` (as of ${s.netIncomeUsd.asOf})`:""," [USD]"]})]}),((E=s.assetsUsd)==null?void 0:E.v)!=null&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Assets (US-GAAP):"})}),e.jsxs("td",{children:["$",O(s.assetsUsd.v),s.assetsUsd.asOf?` (as of ${s.assetsUsd.asOf})`:""," [USD]"]})]}),((b=s.liabilitiesUsd)==null?void 0:b.v)!=null&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Liabilities (US-GAAP):"})}),e.jsxs("td",{children:["$",O(s.liabilitiesUsd.v),s.liabilitiesUsd.asOf?` (as of ${s.liabilitiesUsd.asOf})`:""," [USD]"]})]}),((N=s.shares)==null?void 0:N.v)!=null&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Shares (US-GAAP):"})}),e.jsxs("td",{children:["$",O(s.shares.v),s.shares.asOf?` (as of ${s.shares.asOf})`:""," [",s.shares.unit||"shares","]"]})]})]}):null,e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:i.subhead,children:"Key metrics (Finnhub)"})}),r?e.jsxs(e.Fragment,{children:[e.jsx("tr",{children:e.jsx("td",{colSpan:2,children:e.jsx(K,{height:14})})}),e.jsx("tr",{children:e.jsx("td",{colSpan:2,children:e.jsx(K,{height:14})})}),e.jsx("tr",{children:e.jsx("td",{colSpan:2,children:e.jsx(K,{height:14})})})]}):x?e.jsx("tr",{children:e.jsxs("td",{colSpan:2,className:i.errorText,children:["Finnhub error: ",x]})}):e.jsxs(e.Fragment,{children:[e.jsxs("tr",{children:[e.jsx("td",{children:"P/E (TTM):"}),e.jsx("td",{children:h.pe!=null?U(h.pe):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"P/S (TTM):"}),e.jsx("td",{children:h.ps!=null?U(h.ps):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"P/B:"}),e.jsx("td",{children:h.pb!=null?U(h.pb):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"PEG:"}),e.jsx("td",{children:h.peg!=null?U(h.peg):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"EV/EBITDA:"}),e.jsx("td",{children:h.evEbitda!=null?U(h.evEbitda):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"ROE (TTM):"}),e.jsx("td",{children:h.roe!=null?U(h.roe):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"ROIC (TTM):"}),e.jsx("td",{children:h.roic!=null?U(h.roic):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Gross Margin (TTM):"}),e.jsx("td",{children:h.grossMargin!=null?U(h.grossMargin):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Net Margin (TTM):"}),e.jsx("td",{children:h.netMargin!=null?U(h.netMargin):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Debt / Equity:"}),e.jsx("td",{children:h.dToE!=null?U(h.dToE):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Current Ratio:"}),e.jsx("td",{children:h.currentRatio!=null?U(h.currentRatio):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Market Cap:"}),e.jsx("td",{children:h.marketCap!=null?"$"+O(h.marketCap):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Shares (Basic):"}),e.jsx("td",{children:h.shares!=null?O(h.shares):"—"})]}),e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:i.subhead,children:"Valuation helpers"})}),e.jsxs("tr",{children:[e.jsx("td",{children:"Net Debt:"}),e.jsx("td",{children:w.netDebt!=null?"$"+O(w.netDebt):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Enterprise Value (EV):"}),e.jsx("td",{children:w.ev!=null?"$"+O(w.ev):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"FCF (TTM):"}),e.jsx("td",{children:w.fcf!=null?"$"+O(w.fcf):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"FCF Yield (TTM):"}),e.jsx("td",{children:w.fcfYield!=null?(w.fcfYield*100).toFixed(2)+"%":"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"EV / FCF (TTM):"}),e.jsx("td",{children:w.evPerFcf!=null?U(w.evPerFcf):"—"})]})]})]})})]})};function Le(t){const n=typeof t=="number"?t:Number(t);return Number.isFinite(n)?Math.abs(n)>=100?n.toFixed(0):n.toFixed(2):String(t??"—")}const qe=({metric:t,loading:n,error:c})=>e.jsxs("details",{className:i.rawBlock,open:!0,children:[e.jsx("summary",{className:i.rawSummary,children:"All metrics (raw)"}),e.jsx("div",{className:i.rawTableWrap,children:n?e.jsx(K,{count:6}):c?e.jsx("div",{className:i.errorText,children:"Failed to load metrics."}):e.jsxs("table",{className:i.metricsTable,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Field"}),e.jsx("th",{children:"Value"})]})}),e.jsx("tbody",{children:Object.entries(t||{}).sort((l,r)=>l[0].localeCompare(r[0])).map(([l,r])=>e.jsxs("tr",{children:[e.jsx("td",{className:i.keyCell,children:l}),e.jsx("td",{className:i.valCell,children:typeof r=="number"?Le(r):String(r)})]},l))})]})})]}),He=({loading:t})=>{const{t:n}=le();return e.jsxs("div",{className:i.chartCard,children:[e.jsx("h3",{children:n("stockDetails.chart")}),e.jsxs("div",{className:i.chartPlaceholder,children:["(",n("stockDetails.chartPlaceholder"),")"]})]})};function Y(t,n){for(const c of n){const l=t==null?void 0:t[c];if(typeof l=="number"&&Number.isFinite(l))return l}return null}function z(t){return Math.abs(t)>=100?t.toFixed(0):t.toFixed(2)}function J(t){return typeof t=="number"&&Number.isFinite(t)}function We(t){const n=[],c=[],l=[],r=Y(t,["peTTM","peInclExtraTTM","peExclExtraTTM","peBasicExclExtraTTM"]);J(r)&&r>0&&r<10&&n.push(`Low P/E ${z(r)} — potential undervaluation.`);const x=Y(t,["psTTM","psAnnual"]);J(x)&&x<1&&n.push(`P/S ${z(x)} < 1 — inexpensive sales.`);const a=Y(t,["pb","priceToBookAnnual"]);J(a)&&a<1&&n.push(`P/B ${z(a)} < 1 — trades below book value.`);const p=Y(t,["grossMarginTTM","grossMarginAnnual"]);J(p)&&n.push(`Gross margin ${z(p)}% — indicative of pricing power.`);const j=Y(t,["currentRatioTTM","currentRatioAnnual"]);J(j)&&j>=1.5&&n.push(`Current ratio ${z(j)} — comfortable liquidity.`);const s=Y(t,["netProfitMarginTTM","netMarginAnnual"]);J(s)&&s<0&&c.push(`Net margin ${z(s)}% — loss-making on a TTM basis.`);const v=Y(t,["debtToEquityTTM","debtToEquityAnnual"]);return J(v)&&v>1&&c.push(`Debt/Equity ${z(v)} — elevated leverage.`),!n.length&&!c.length&&l.push("Not enough metrics for a definitive view."),{strengths:n,risks:c,notes:l}}const ie=t=>{const n=typeof t=="number"?t:Number(t);return Number.isFinite(n)?n:null};function q(t,n){if(!t)return null;for(const c of n){const l=ie(t[c]);if(l!==null)return l}return null}function Ye(t){return t==="large"?{pe:{low:12,base:16,high:22},pfcf:{low:12,base:16,high:22},ps:{low:1,base:1.5,high:2},pb:{low:1,base:1.4,high:1.9}}:t==="mid"?{pe:{low:10,base:14,high:18},pfcf:{low:10,base:14,high:18},ps:{low:.8,base:1.2,high:1.6},pb:{low:.8,base:1.2,high:1.6}}:{pe:{low:8,base:12,high:16},pfcf:{low:8,base:12,high:16},ps:{low:.5,base:1,high:1.5},pb:{low:.7,base:1,high:1.3}}}function Q(t){return t==null?null:Math.round(t*100)/100}function ze(t){var X,W;const n=[],c=t.metric??{},l=ie(t.price),r=Math.max(0,Math.min(.9,((X=t.options)==null?void 0:X.marginOfSafety)??.3)),x=Math.max(1,Math.min(20,((W=t.options)==null?void 0:W.riskCapMultiple)??5));if(l==null||l<=0)return{blended:null,methods:[],mos:{threshold:r,pass:null},warnings:["Price is missing — cannot compute valuation."],altCalcs:[],compositeAverage:null};const a=t.category??null,p=Ye(a),j=q(c,["peTTM","peInclExtraTTM","peExclExtraTTM","peBasicExclExtraTTM"]),s=q(c,["psTTM","psAnnual"]),v=q(c,["pb","priceToBookAnnual","ptbvQuarterly","ptbvAnnual"]),o=q(c,["pfcfShareTTM","pfcfShareAnnual"]),h=q(c,["netProfitMarginTTM","netMarginAnnual","netProfitMargin5Y"]),w=q(c,["roeTTM","roeAnnual"]),B=q(c,["revenueGrowthTTMYoy","revenueGrowthQuarterlyYoy"]),u=q(c,["52WeekPriceReturnDaily","yearToDatePriceReturnDaily"]),_=q(c,["beta"]);let E=!1;const b={pe:{...p.pe},pfcf:{...p.pfcf},ps:{...p.ps},pb:{...p.pb}};h!=null&&h<0&&(b.pe.low*=.5,b.pe.base*=.5,b.pe.high*=.5,b.pfcf.low*=.5,b.pfcf.base*=.5,b.pfcf.high*=.5,n.push("Negative net margin — downshifted PE/PFCF targets.")),w!=null&&w<5&&(b.pb.low*=.7,b.pb.base*=.7,b.pb.high*=.7,n.push("Low ROE — downshifted PB targets.")),B!=null&&B<0&&(b.ps.low*=.75,b.ps.base*=.75,b.ps.high*=.75,n.push("Negative revenue growth — downshifted PS targets.")),(u!=null&&u<=-90||_!=null&&_>2.2)&&(E=!0,n.push("High-risk profile (52w drawdown or high beta)."));const N=(f,R)=>f==null||!Number.isFinite(f)||f<=0?null:Q(l*(R/f)),d=[j!=null?{key:"pe",available:!0,low:N(j,b.pe.low),base:N(j,b.pe.base),high:N(j,b.pe.high)}:{key:"pe",available:!1},o!=null?{key:"pfcf",available:!0,low:N(o,b.pfcf.low),base:N(o,b.pfcf.base),high:N(o,b.pfcf.high)}:{key:"pfcf",available:!1},s!=null?{key:"ps",available:!0,low:N(s,b.ps.low),base:N(s,b.ps.base),high:N(s,b.ps.high)}:{key:"ps",available:!1},v!=null?{key:"pb",available:!0,low:N(v,b.pb.low),base:N(v,b.pb.base),high:N(v,b.pb.high)}:{key:"pb",available:!1}],g=Object.fromEntries(d.map(f=>[f.key,f.available]));let y={};g.pfcf&&g.pe?y={pfcf:.45,pe:.3,pb:.15,ps:.1}:g.pfcf&&!g.pe?y={pfcf:.6,ps:.25,pb:.15}:!g.pfcf&&g.pe?y={pe:.55,pb:.3,ps:.15}:(g.ps||g.pb)&&(y={ps:.6,pb:.4});let I=0;for(const f of Object.keys(y))g[f]?I+=y[f]:delete y[f];for(const f of Object.keys(y))y[f]=y[f]/I;const D=f=>{if(!I)return null;let R=0;for(const S of d){if(!S.available||S[f]==null)continue;const V=y[S.key]??0;R+=S[f]*V}return Q(R)};let M={low:D("low"),base:D("base"),high:D("high")};const F=f=>{const R=d.filter(V=>V.available&&V[f]!=null).map(V=>V[f]);if(!R.length)return null;const S=R.reduce((V,ae)=>V+ae,0)/R.length;return Q(S)},L=()=>F("low");d.find(f=>f.key==="pe");const C=d.find(f=>f.key==="ps"),k=d.find(f=>f.key==="pb"),A=[];A.push({key:"blend",label:"Multiples Blend (cap-size targets)",source:"Price × (TargetMultiple / CurrentMultiple) blended across P/FCF, P/E, P/S, P/B; targets by market-cap band with risk downshifts and sanity cap.",available:M.base!=null,low:M.low,base:M.base,high:M.high}),A.push({key:"equal_weight",label:"Equal-Weight Multiples",source:"Average of Price × (Target/Current) across available multiples (PE, PFCF, PS, PB).",available:F("base")!=null,low:F("low"),base:F("base"),high:F("high")});const m=L();if(A.push({key:"downside",label:"Downside (Low Targets)",source:"Average of *low* target prices across available multiples; conservative case.",available:m!=null,low:m,base:m,high:m}),A.push({key:"pb_only",label:"PB-only (ROE-tuned)",source:"Price × (TargetPB / CurrentPB), with TargetPB reduced when ROE < 5%.",available:!!(k!=null&&k.available&&k.base!=null),low:(k==null?void 0:k.low)??null,base:(k==null?void 0:k.base)??null,high:(k==null?void 0:k.high)??null}),A.push({key:"ps_only",label:"PS-only (Margin-tuned)",source:"Price × (TargetPS / CurrentPS), with TargetPS reduced when margins/growth are weak.",available:!!(C!=null&&C.available&&C.base!=null),low:(C==null?void 0:C.low)??null,base:(C==null?void 0:C.base)??null,high:(C==null?void 0:C.high)??null}),E){const f=S=>{if(S==null)return null;const V=l*x;return S>V?Q(V):S};M=(S=>({low:f(S.low),base:f(S.base),high:f(S.high)}))(M);for(const S of A)S.low=f(S.low),S.base=f(S.base),S.high=f(S.high);n.push(`High-risk sanity cap applied at ×${x} of current price.`)}const P=M.base!=null?l<=M.base*(1-r):null,$=A.filter(f=>f.available&&f.base!=null).map(f=>f.base),te=$.length?Q($.reduce((f,R)=>f+R,0)/$.length):null;return{blended:M,methods:d,mos:{threshold:r,pass:P},warnings:n,altCalcs:A,compositeAverage:te}}function Je(t,n){const c=(t||"").toUpperCase(),l=Z(v=>v.stocks.items.find(o=>o.ticker===c)),r=Z(re(c)),[x,a]=T.useState(null),[p,j]=T.useState(!1),s=T.useMemo(()=>{const v=[x,n,r==null?void 0:r.price,l==null?void 0:l.price,l==null?void 0:l.prevClose,l==null?void 0:l.open,l==null?void 0:l.high,l==null?void 0:l.low];for(const o of v)if(typeof o=="number"&&Number.isFinite(o)&&o>0)return o;return null},[x,n,r==null?void 0:r.price,l==null?void 0:l.price,l==null?void 0:l.prevClose,l==null?void 0:l.open,l==null?void 0:l.high,l==null?void 0:l.low]);return T.useEffect(()=>{let v=!1;return(async()=>{var o;if(!(s!=null||p||!c))try{j(!0);const h=await ee(`/api/fh/snapshot-batch?symbols=${encodeURIComponent(c)}`,{noStore:!0,timeoutMs:12e3}),w=((o=h==null?void 0:h.items)==null?void 0:o[0])||{},B=[w.price,w.prevClose,w.open,w.high,w.low].find(u=>typeof u=="number"&&Number.isFinite(u)&&u>0);!v&&typeof B=="number"&&a(B)}catch{}finally{v||j(!1)}})(),()=>{v=!0}},[s,p,c]),{priceNow:s,fetchingPrice:p,stock:l,seed:r}}const se={};function Ke(t){let n=2166136261;for(let c=0;c<t.length;c++)n^=t.charCodeAt(c),n=Math.imul(n,16777619);return(n>>>0).toString(16)}const Qe=6*60*60*1e3,ne=typeof import.meta<"u"&&(se==null?void 0:se.VITE_DISABLE_GPT)==="1",Xe=({symbol:t,priceNow:n,category:c,metric:l,valuation:r})=>{const[x,a]=T.useState(!1),[p,j]=T.useState(!1),[s,v]=T.useState(null),[o,h]=T.useState(null);function w(u){return u.includes("OPENAI_API_KEY not set")?"ChatGPT не настроен: добавьте OPENAI_API_KEY в переменные окружения сервера и перезапустите.":/429/.test(u)&&/quota/i.test(u)?"ChatGPT: исчерпана квота аккаунта OpenAI (нужна оплата/кредиты в Billing).":/429/.test(u)?"ChatGPT: слишком часто. Запрос ограничен со стороны сервера.":u}async function B(){if(!p){j(!0),v(null);try{if(ne)throw new Error("ChatGPT временно отключён админ-флагом (VITE_DISABLE_GPT=1).");const u=l||{},_={pe:u.peTTM??u.peInclExtraTTM??u.peExclExtraTTM??null,pfcf:u.pfcfShareTTM??u.pfcfShareAnnual??null,ps:u.psTTM??u.psAnnual??null,pb:u.pb??u.ptbvQuarterly??u.ptbvAnnual??null,grossMargin:u.grossMarginTTM??null,netMargin:u.netProfitMarginTTM??null,roe:u.roeTTM??null,roic:u.roicTTM??null,revGyoy:u.revenueGrowthTTMYoy??null,beta:u.beta??null,debtToEquity:u.debtToEquityTTM??u.debtToEquityAnnual??null,currentRatio:u.currentRatioTTM??u.currentRatioAnnual??null},E={symbol:t,priceNow:n,category:c,metric:_,valuation:{blended:r.blended,compositeAverage:r.compositeAverage,altCalcs:r.altCalcs.map(M=>({label:M.label,low:M.low??null,base:M.base??null,high:M.high??null})),warnings:r.warnings}},b=`LLM:${t}:${Ke(JSON.stringify({s:t,p:n,c,m:_,v:E.valuation}))}`,N=window.sessionStorage,d=N.getItem(b);if(d){const M=JSON.parse(d);if(M.exp>Date.now()&&M.text){h(M.text),a(!0),j(!1);return}else N.removeItem(b)}const g=await fetch("/api/llm/commentary",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(E)}),y=await g.text().catch(()=>"");if(!g.ok)throw new Error(`${g.status} ${g.statusText}${y?` — ${y}`:""}`);const{commentary:I}=JSON.parse(y),D=I||"No commentary received.";h(D),N.setItem(b,JSON.stringify({text:D,exp:Date.now()+Qe})),a(!0)}catch(u){v(w(String((u==null?void 0:u.message)||u)))}finally{j(!1)}}}return e.jsxs("div",{style:{marginTop:12},children:[e.jsx("button",{className:i.viewButton,style:{padding:"0.45rem 0.9rem"},onClick:B,disabled:p,title:ne?"ChatGPT отключён (env flag)":"Отправить текущие метрики и оценки в ChatGPT для комментария",children:p?"Asking ChatGPT…":ne?"ChatGPT disabled":"Show ChatGPT commentary"}),s?e.jsxs("p",{className:i.errorText,style:{marginTop:8},children:["ChatGPT error: ",s]}):null,x&&o?e.jsxs("div",{className:i.rawTableWrap,style:{marginTop:8,padding:12},children:[e.jsx("div",{className:i.muted,style:{marginBottom:6},children:"AI commentary (not investment advice):"}),e.jsx("div",{style:{whiteSpace:"pre-wrap",lineHeight:1.4},children:o})]}):null]})};function H(t){return t==null||!Number.isFinite(t)?"—":`$${t.toFixed(2)}`}const Ze=({symbol:t,metric:n,metricsLoading:c,priceSeed:l})=>{var y,I,D,M,F,L,C,k,A;const{priceNow:r,fetchingPrice:x,stock:a,seed:p}=Je(t,l),j=(p==null?void 0:p.category)??(a==null?void 0:a.category)??null,[s,v]=T.useState(!1),[o,h]=T.useState(null),[w,B]=T.useState(null),u=T.useMemo(()=>c?"Metrics are still loading…":n?r==null?x?"Fetching price snapshot…":"No price/OHLC snapshot yet":null:"Metrics not loaded yet",[c,n,r,x]),_=!u,E=T.useCallback(()=>{if(!(!_||s)){v(!0),B(null);try{const m=ze({price:r,category:j,metric:n,options:{marginOfSafety:.3,riskCapMultiple:5}});h(m)}catch(m){B(String((m==null?void 0:m.message)||m)),h(null)}finally{v(!1)}}},[_,s,r,j,n]),b=T.useMemo(()=>{var $;if(!(($=o==null?void 0:o.blended)!=null&&$.base)||!r)return"—";const m=(o.blended.base-r)/r,P=Math.abs(m*100).toFixed(2)+"%";return m>=0?`Discount ${P}`:`Premium ${P}`},[(y=o==null?void 0:o.blended)==null?void 0:y.base,r]),N=T.useMemo(()=>{if(!(o!=null&&o.compositeAverage)||!r)return"—";const m=(o.compositeAverage-r)/r,P=Math.abs(m*100).toFixed(2)+"%";return m>=0?`Discount ${P}`:`Premium ${P}`},[o==null?void 0:o.compositeAverage,r]),d=r?r*5:null,g=m=>d!=null&&typeof m=="number"&&Math.abs(m-d)<.005;return e.jsxs("div",{className:i.fvCard,children:[e.jsxs("div",{className:i.fvHeader,children:[e.jsx("h4",{className:i.fvTitle,children:"Fair Value (ratio-based)"}),e.jsx("button",{onClick:E,disabled:!_||s,className:i.viewButton,style:{padding:"0.45rem 0.9rem"},title:_?"Compare Fair Value with current price":u??"",children:s?"Computing…":"Compare Fair Value"})]}),!_&&e.jsx("p",{className:i.muted,style:{marginTop:4},children:u}),!o&&!w&&_&&e.jsx("p",{className:i.muted,children:"Uses current multiples (P/E, P/FCF, P/S, P/B) → target ranges by size band with risk downshifts & sanity caps."}),w?e.jsxs("p",{className:i.errorText,children:["Valuation error: ",w]}):null,o?e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:i.muted,style:{marginTop:4},children:[e.jsx("strong",{children:"Source:"})," Price × (TargetMultiple / CurrentMultiple), blended across available multiples; targets depend on market-cap band; risk downshifts (neg. margin, low ROE, neg. growth) and a high-risk sanity cap."]}),e.jsxs("div",{className:i.fvGrid,children:[e.jsxs("div",{className:i.kpi,children:[e.jsx("div",{className:i.kpiTitle,children:"Price (now)"}),e.jsx("div",{className:i.kpiValue,children:H(r)})]}),e.jsxs("div",{className:i.kpi,children:[e.jsx("div",{className:i.kpiTitle,children:"Fair Value (base)"}),e.jsxs("div",{className:i.kpiValue,children:[H(((I=o.blended)==null?void 0:I.base)??null),g((D=o.blended)==null?void 0:D.base)?" (capped ×5)":""]}),((M=o.blended)==null?void 0:M.low)!=null&&((F=o.blended)==null?void 0:F.high)!=null?e.jsxs("div",{className:i.kpiSub,children:["Low ",H(o.blended.low)," · High ",H(o.blended.high)]}):null]}),e.jsxs("div",{className:i.kpi,children:[e.jsx("div",{className:i.kpiTitle,children:"Discount / Premium"}),e.jsx("div",{className:i.kpiValue,children:b})]}),e.jsxs("div",{className:i.kpi,children:[e.jsx("div",{className:i.kpiTitle,children:"MoS (30%) Pass"}),e.jsx("div",{className:i.kpiValue,children:((L=o.mos)==null?void 0:L.pass)==null?"—":o.mos.pass?"YES":"NO"}),((C=o.mos)==null?void 0:C.threshold)!=null&&((k=o.blended)==null?void 0:k.base)!=null?e.jsxs("div",{className:i.kpiSub,children:["Threshold: ",H(o.blended.base*(1-o.mos.threshold))]}):null]})]}),e.jsxs("details",{className:i.rawBlock,open:!0,children:[e.jsx("summary",{className:i.rawSummary,children:"Calculators (side-by-side)"}),e.jsx("div",{className:i.rawTableWrap,children:e.jsxs("table",{className:i.metricsTable,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Calculator"}),e.jsx("th",{children:"Low"}),e.jsx("th",{children:"Base"}),e.jsx("th",{children:"High"}),e.jsx("th",{children:"Source"})]})}),e.jsx("tbody",{children:o.altCalcs.map((m,P)=>e.jsxs("tr",{children:[e.jsx("td",{className:i.keyCell,children:m.label}),e.jsx("td",{className:i.valCell,children:H(m.low??null)}),e.jsxs("td",{className:i.valCell,children:[H(m.base??null),g(m.base??null)?" (capped ×5)":""]}),e.jsx("td",{className:i.valCell,children:H(m.high??null)}),e.jsx("td",{className:i.valCell,children:e.jsx("span",{className:i.muted,children:m.source})})]},P))})]})})]}),e.jsxs("div",{className:i.fvGrid,style:{marginTop:8},children:[e.jsxs("div",{className:i.kpi,children:[e.jsx("div",{className:i.kpiTitle,children:"Composite Average (across calculators)"}),e.jsx("div",{className:i.kpiValue,children:H(o.compositeAverage)})]}),e.jsxs("div",{className:i.kpi,children:[e.jsx("div",{className:i.kpiTitle,children:"Discount / Premium vs Average"}),e.jsx("div",{className:i.kpiValue,children:N})]})]}),(A=o.warnings)!=null&&A.length?e.jsxs("details",{className:i.rawBlock,open:!0,children:[e.jsx("summary",{className:i.rawSummary,children:"Warnings & assumptions"}),e.jsx("ul",{style:{margin:"0.25rem 0 0 1rem"},children:o.warnings.map((m,P)=>e.jsxs("li",{className:i.muted,children:["• ",m]},P))})]}):null,e.jsx(Xe,{symbol:t,priceNow:r,category:j,metric:n,valuation:o})]}):null]})},et=({symbol:t,metric:n,metricsLoading:c,priceSeed:l})=>{const r=n?We(n):null;return e.jsxs("div",{className:i.aboutCard,children:[e.jsx("h3",{children:"About the Company"}),e.jsx("p",{style:{opacity:.8},children:"No long description available."}),r?e.jsxs("div",{style:{marginTop:"0.5rem"},children:[!!r.strengths.length&&e.jsx("ul",{style:{margin:"0.25rem 0"},children:r.strengths.map((x,a)=>e.jsxs("li",{children:["✅ ",x]},"s"+a))}),!!r.risks.length&&e.jsx("ul",{style:{margin:"0.25rem 0"},children:r.risks.map((x,a)=>e.jsxs("li",{children:["⚠️ ",x]},"r"+a))}),!!r.notes.length&&e.jsx("p",{style:{marginTop:6},children:r.notes.join(" ")})]}):null,e.jsx(Ze,{symbol:t,metric:n,metricsLoading:c,priceSeed:l})]})},lt=()=>{var N;const{t}=le(),{ticker:n}=oe(),c=ce(),l=de(),r=(n||"").toUpperCase(),x=Z(d=>d.stocks.items.find(g=>g.ticker===r)),a=Z(re(r)),p=(N=c.state)==null?void 0:N.seed,j=(p==null?void 0:p.price)??(a==null?void 0:a.price)??(x==null?void 0:x.price)??null,s=(p==null?void 0:p.category)??(a==null?void 0:a.category)??(x==null?void 0:x.category)??null;T.useEffect(()=>{r&&l(ue({ticker:r}))},[r,l]);const{loading:v,error:o,metric:h}=Ue(r),{loading:w,error:B,profile:u}=Ge(r),{error:_,facts:E}=Oe(r),b=T.useMemo(()=>{const d=((u==null?void 0:u.name)??"").trim(),g=((x==null?void 0:x.name)??"").trim(),y=((E==null?void 0:E.entityName)??"").trim();return d||g||y||null},[u==null?void 0:u.name,x==null?void 0:x.name,E==null?void 0:E.entityName]);return e.jsxs(he.div,{className:i.wrapper,initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:[e.jsx("h1",{className:i.title,children:r?`${b??t("stockDetails.namePlaceholder")} (${r})`:e.jsx(K,{width:300})}),e.jsxs("div",{className:i.grid,children:[e.jsx(Ve,{symbol:r,priceSeed:j,categorySeed:s,metric:h,metricsLoading:v,metricsError:o,p2:u,p2Loading:w,p2Error:B,secFacts:E,secError:_}),e.jsx(He,{})]}),e.jsx(qe,{metric:h,loading:v,error:o}),e.jsx(et,{symbol:r,metric:h,metricsLoading:v,priceSeed:j})]})};export{lt as StockDetails,lt as default};
