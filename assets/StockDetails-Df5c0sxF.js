import{r as T,f as te,u as le,j as e,d as ee,m as ie,a as ae,n as he,o as oe,c as ue,p as fe,q as pe}from"./index-xvdbN6-H.js";import{S as q}from"./skeleton-CO-u1M0P.js";import{m as xe}from"./proxy-BozZERwT.js";const ge="_wrapper_1lbh8_1",me="_title_1lbh8_9",be="_grid_1lbh8_16",je="_infoCard_1lbh8_23",ye="_chartCard_1lbh8_23",Te="_aboutCard_1lbh8_23",ve="_table_1lbh8_31",we="_subhead_1lbh8_42",Se="_chartPlaceholder_1lbh8_52",Me="_fvCard_1lbh8_64",Ne="_fvHeader_1lbh8_65",ke="_fvTitle_1lbh8_66",Ce="_fvGrid_1lbh8_68",Pe="_kpi_1lbh8_69",Ee="_kpiTitle_1lbh8_70",_e="_kpiValue_1lbh8_71",Ae="_kpiSub_1lbh8_72",Ie="_muted_1lbh8_74",$e="_rawBlock_1lbh8_77",De="_rawSummary_1lbh8_81",Re="_rawTableWrap_1lbh8_91",Be="_metricsTable_1lbh8_99",Fe="_keyCell_1lbh8_119",Oe="_valCell_1lbh8_125",Ue="_errorText_1lbh8_131",d={wrapper:ge,title:me,grid:be,infoCard:je,chartCard:ye,aboutCard:Te,table:ve,subhead:we,chartPlaceholder:Se,fvCard:Me,fvHeader:Ne,fvTitle:ke,fvGrid:Ce,kpi:Pe,kpiTitle:Ee,kpiValue:_e,kpiSub:Ae,muted:Ie,rawBlock:$e,rawSummary:De,rawTableWrap:Re,metricsTable:Be,keyCell:Fe,valCell:Oe,errorText:Ue};function Ge(t){const[l,a]=T.useState(!0),[r,n]=T.useState(null),[p,c]=T.useState(null);return T.useEffect(()=>{let x=!1;async function y(){if(t){a(!0),n(null);try{const s=await te(`/api/fh/metrics?symbol=${encodeURIComponent(t)}`,{noStore:!0,timeoutMs:2e4});x||c((s==null?void 0:s.metric)??{})}catch(s){x||n(String((s==null?void 0:s.message)||s))}finally{x||a(!1)}}}return y(),()=>{x=!0}},[t]),{loading:l,error:r,metric:p}}function Le(t){const[l,a]=T.useState(!0),[r,n]=T.useState(null),[p,c]=T.useState(null);return T.useEffect(()=>{let x=!1;async function y(){if(t){a(!0),n(null);try{const s=await te(`/api/fh/profile2?symbol=${encodeURIComponent(t)}`,{noStore:!0,timeoutMs:15e3});x||c((s==null?void 0:s.profile)??null)}catch(s){x||n(String((s==null?void 0:s.message)||s))}finally{x||a(!1)}}}return y(),()=>{x=!0}},[t]),{loading:l,error:r,profile:p}}function Ve(t){const[l,a]=T.useState(!0),[r,n]=T.useState(null),[p,c]=T.useState(null);return T.useEffect(()=>{let x=!1;async function y(){if(t){a(!0),n(null);try{const s=await te(`/api/sec/company-facts?symbol=${encodeURIComponent(t)}`,{noStore:!0,timeoutMs:2e4});x||c(s??null)}catch(s){x||n(String((s==null?void 0:s.message)||s))}finally{x||a(!1)}}}return y(),()=>{x=!0}},[t]),{loading:l,error:r,facts:p}}function W(t){return typeof t!="number"||!Number.isFinite(t)?"—":Math.abs(t)>=1e12?(t/1e12).toFixed(2)+"T":Math.abs(t)>=1e9?(t/1e9).toFixed(2)+"B":Math.abs(t)>=1e6?(t/1e6).toFixed(2)+"M":Math.abs(t)>=1e3?(t/1e3).toFixed(2)+"K":t.toFixed(2)}function V(t){const l=typeof t=="number"?t:Number(t);return Number.isFinite(l)?Math.abs(l)>=100?l.toFixed(0):l.toFixed(2):String(t??"—")}function Y(t,l){if(!t)return null;for(const a of l){const r=t[a];if(typeof r=="number"&&Number.isFinite(r))return r}return null}function Ye(t){if(!t)return"—";const l=String(t).toLowerCase();return l.charAt(0).toUpperCase()+l.slice(1)}const ze=({symbol:t,priceSeed:l,categorySeed:a,metric:r,metricsLoading:n,metricsError:p,p2:c,p2Loading:x,p2Error:y,secFacts:s,secError:b})=>{var u,R,_,v,P;const{t:o}=le(),g=T.useMemo(()=>{const f=r||{},S=Y(f,["peTTM","peInclExtraTTM","peExclExtraTTM","peAnnual","peBasicExclExtraTTM"]),N=Y(f,["psTTM","psAnnual"]),O=Y(f,["pb","priceToBookAnnual"]),F=Y(f,["pegAnnual","pegRatio"]),k=Y(f,["enterpriseValueOverEBITDA","evebitdaAnnual"]),U=Y(f,["roeTTM","roeAnnual"]),z=Y(f,["roicTTM","roicAnnual"]),I=Y(f,["grossMarginTTM","grossMarginAnnual"]),$=Y(f,["netProfitMarginTTM","netMarginAnnual"]),w=Y(f,["debtToEquityAnnual","debtToEquityTTM"]),m=Y(f,["currentRatioAnnual","currentRatioTTM"]),i=Y(f,["marketCapitalization"]),E=Y(f,["sharesBasic"]);return{pe:S,ps:N,pb:O,peg:F,evEbitda:k,roe:U,roic:z,grossMargin:I,netMargin:$,dToE:w,currentRatio:m,marketCap:i,shares:E}},[r]),M=T.useMemo(()=>{const f=r||{},S=A=>typeof A=="number"&&Number.isFinite(A)?A:null,N=S(f.marketCapitalization??g.marketCap),O=S(f.enterpriseValue),F=S(f.totalDebt),k=S(f.totalCash??f.totalCashAndEquivalents??(f==null?void 0:f.cashAndEq)),U=S(f.operatingCashFlowTTM??(f==null?void 0:f.operatingCfTTM)),z=S(f.capitalExpenditureTTM??(f==null?void 0:f.capexTTM)),I=S((f==null?void 0:f.pfcfShareTTM)??(f==null?void 0:f.pfcfShareAnnual)),$=typeof l=="number"&&Number.isFinite(l)?l:null,w=S(g.shares)??S(c==null?void 0:c.shareOutstanding);let m=null,i=null;F!=null&&k!=null?(m=F-k,N!=null&&(i=N+m)):O!=null&&N!=null&&(i=O,m=i-N);let E=null;U!=null&&z!=null?E=U-z:$!=null&&I!=null&&I>0&&w!=null&&w>0&&(E=$/I*w);const j=E!=null&&N!=null&&N>0?E/N:null,C=E!=null&&E!==0&&i!=null?i/E:null;return{netDebt:m,ev:i,fcf:E,fcfYield:j,evPerFcf:C}},[r,g.marketCap,g.shares,c==null?void 0:c.shareOutstanding,l]),B=(s==null?void 0:s.entityName)||null;return e.jsxs("div",{className:d.infoCard,children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:8},children:[c!=null&&c.logo?e.jsx("img",{src:c.logo,alt:"logo",style:{width:36,height:36,objectFit:"contain"}}):null,e.jsx("h3",{style:{margin:0},children:o("stockDetails.info")})]}),e.jsx("table",{className:d.table,children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("strong",{children:[o("stockDetails.ticker"),":"]})}),e.jsx("td",{children:t})]}),!x&&!c&&B?e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Name:"})}),e.jsx("td",{children:B})]}):null,e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("strong",{children:[o("stockDetails.price"),":"]})}),e.jsx("td",{children:l!=null?`$${V(l)}`:"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("strong",{children:[o("stockDetails.category"),":"]})}),e.jsx("td",{children:a?Ye(a):"—"})]}),x?e.jsxs(e.Fragment,{children:[e.jsx("tr",{children:e.jsx("td",{colSpan:2,children:e.jsx(q,{height:12})})}),e.jsx("tr",{children:e.jsx("td",{colSpan:2,children:e.jsx(q,{height:12})})})]}):y?e.jsx("tr",{children:e.jsxs("td",{colSpan:2,className:d.errorText,children:["FH Profile2 error: ",y]})}):c?e.jsxs(e.Fragment,{children:[c.name&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Name:"})}),e.jsx("td",{children:c.name})]}),c.finnhubIndustry&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Industry:"})}),e.jsx("td",{children:c.finnhubIndustry})]}),(c.exchange||c.country)&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Listing:"})}),e.jsx("td",{children:[c.exchange,c.country].filter(Boolean).join(", ")})]}),c.ipo&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"IPO:"})}),e.jsx("td",{children:c.ipo})]}),typeof c.marketCapitalization=="number"&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Market Cap (FH):"})}),e.jsxs("td",{children:["$",W(c.marketCapitalization)]})]}),typeof c.shareOutstanding=="number"&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Shares Out:"})}),e.jsx("td",{children:W(c.shareOutstanding)})]}),c.weburl&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Website:"})}),e.jsx("td",{children:e.jsx("a",{href:c.weburl,target:"_blank",rel:"noreferrer noopener",children:c.weburl})})]})]}):null,b?e.jsx("tr",{children:e.jsxs("td",{colSpan:2,className:d.errorText,children:["SEC error: ",b]})}):s?e.jsxs(e.Fragment,{children:[(s.entityName||s.cik)&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"SEC Entity:"})}),e.jsx("td",{children:[s.entityName,s.cik?`CIK ${s.cik}`:""].filter(Boolean).join(" — ")})]}),((u=s.revenueUsd)==null?void 0:u.v)!=null&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Revenue (US-GAAP):"})}),e.jsxs("td",{children:["$",W(s.revenueUsd.v),s.revenueUsd.asOf?` (as of ${s.revenueUsd.asOf})`:""," [USD]"]})]}),((R=s.netIncomeUsd)==null?void 0:R.v)!=null&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Net Income (US-GAAP):"})}),e.jsxs("td",{children:["$",W(s.netIncomeUsd.v),s.netIncomeUsd.asOf?` (as of ${s.netIncomeUsd.asOf})`:""," [USD]"]})]}),((_=s.assetsUsd)==null?void 0:_.v)!=null&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Assets (US-GAAP):"})}),e.jsxs("td",{children:["$",W(s.assetsUsd.v),s.assetsUsd.asOf?` (as of ${s.assetsUsd.asOf})`:""," [USD]"]})]}),((v=s.liabilitiesUsd)==null?void 0:v.v)!=null&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Liabilities (US-GAAP):"})}),e.jsxs("td",{children:["$",W(s.liabilitiesUsd.v),s.liabilitiesUsd.asOf?` (as of ${s.liabilitiesUsd.asOf})`:""," [USD]"]})]}),((P=s.shares)==null?void 0:P.v)!=null&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Shares (US-GAAP):"})}),e.jsxs("td",{children:["$",W(s.shares.v),s.shares.asOf?` (as of ${s.shares.asOf})`:""," [",s.shares.unit||"shares","]"]})]})]}):null,e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:d.subhead,children:"Key metrics (Finnhub)"})}),n?e.jsxs(e.Fragment,{children:[e.jsx("tr",{children:e.jsx("td",{colSpan:2,children:e.jsx(q,{height:14})})}),e.jsx("tr",{children:e.jsx("td",{colSpan:2,children:e.jsx(q,{height:14})})}),e.jsx("tr",{children:e.jsx("td",{colSpan:2,children:e.jsx(q,{height:14})})})]}):p?e.jsx("tr",{children:e.jsxs("td",{colSpan:2,className:d.errorText,children:["Finnhub error: ",p]})}):e.jsxs(e.Fragment,{children:[e.jsxs("tr",{children:[e.jsx("td",{children:"P/E (TTM):"}),e.jsx("td",{children:g.pe!=null?V(g.pe):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"P/S (TTM):"}),e.jsx("td",{children:g.ps!=null?V(g.ps):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"P/B:"}),e.jsx("td",{children:g.pb!=null?V(g.pb):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"PEG:"}),e.jsx("td",{children:g.peg!=null?V(g.peg):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"EV/EBITDA:"}),e.jsx("td",{children:g.evEbitda!=null?V(g.evEbitda):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"ROE (TTM):"}),e.jsx("td",{children:g.roe!=null?V(g.roe):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"ROIC (TTM):"}),e.jsx("td",{children:g.roic!=null?V(g.roic):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Gross Margin (TTM):"}),e.jsx("td",{children:g.grossMargin!=null?V(g.grossMargin):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Net Margin (TTM):"}),e.jsx("td",{children:g.netMargin!=null?V(g.netMargin):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Debt / Equity:"}),e.jsx("td",{children:g.dToE!=null?V(g.dToE):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Current Ratio:"}),e.jsx("td",{children:g.currentRatio!=null?V(g.currentRatio):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Market Cap:"}),e.jsx("td",{children:g.marketCap!=null?"$"+W(g.marketCap):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Shares (Basic):"}),e.jsx("td",{children:g.shares!=null?W(g.shares):"—"})]}),e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:d.subhead,children:"Valuation helpers"})}),e.jsxs("tr",{children:[e.jsx("td",{children:"Net Debt:"}),e.jsx("td",{children:M.netDebt!=null?"$"+W(M.netDebt):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Enterprise Value (EV):"}),e.jsx("td",{children:M.ev!=null?"$"+W(M.ev):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"FCF (TTM):"}),e.jsx("td",{children:M.fcf!=null?"$"+W(M.fcf):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"FCF Yield (TTM):"}),e.jsx("td",{children:M.fcfYield!=null?(M.fcfYield*100).toFixed(2)+"%":"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"EV / FCF (TTM):"}),e.jsx("td",{children:M.evPerFcf!=null?V(M.evPerFcf):"—"})]})]})]})})]})};function We(t){const l=typeof t=="number"?t:Number(t);return Number.isFinite(l)?Math.abs(l)>=100?l.toFixed(0):l.toFixed(2):String(t??"—")}const qe=({metric:t,loading:l,error:a})=>e.jsxs("details",{className:d.rawBlock,open:!0,children:[e.jsx("summary",{className:d.rawSummary,children:"All metrics (raw)"}),e.jsx("div",{className:d.rawTableWrap,children:l?e.jsx(q,{count:6}):a?e.jsx("div",{className:d.errorText,children:"Failed to load metrics."}):e.jsxs("table",{className:d.metricsTable,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Field"}),e.jsx("th",{children:"Value"})]})}),e.jsx("tbody",{children:Object.entries(t||{}).sort((r,n)=>r[0].localeCompare(n[0])).map(([r,n])=>e.jsxs("tr",{children:[e.jsx("td",{className:d.keyCell,children:r}),e.jsx("td",{className:d.valCell,children:typeof n=="number"?We(n):String(n)})]},r))})]})})]});function K(t,l){for(const a of l){const r=t==null?void 0:t[a];if(typeof r=="number"&&Number.isFinite(r))return r}return null}function Q(t){return Math.abs(t)>=100?t.toFixed(0):t.toFixed(2)}function X(t){return typeof t=="number"&&Number.isFinite(t)}function He(t){const l=[],a=[],r=[],n=K(t,["peTTM","peInclExtraTTM","peExclExtraTTM","peBasicExclExtraTTM"]);X(n)&&n>0&&n<10&&l.push(`Low P/E ${Q(n)} — potential undervaluation.`);const p=K(t,["psTTM","psAnnual"]);X(p)&&p<1&&l.push(`P/S ${Q(p)} < 1 — inexpensive sales.`);const c=K(t,["pb","priceToBookAnnual"]);X(c)&&c<1&&l.push(`P/B ${Q(c)} < 1 — trades below book value.`);const x=K(t,["grossMarginTTM","grossMarginAnnual"]);X(x)&&l.push(`Gross margin ${Q(x)}% — indicative of pricing power.`);const y=K(t,["currentRatioTTM","currentRatioAnnual"]);X(y)&&y>=1.5&&l.push(`Current ratio ${Q(y)} — comfortable liquidity.`);const s=K(t,["netProfitMarginTTM","netMarginAnnual"]);X(s)&&s<0&&a.push(`Net margin ${Q(s)}% — loss-making on a TTM basis.`);const b=K(t,["debtToEquityTTM","debtToEquityAnnual"]);return X(b)&&b>1&&a.push(`Debt/Equity ${Q(b)} — elevated leverage.`),!l.length&&!a.length&&r.push("Not enough metrics for a definitive view."),{strengths:l,risks:a,notes:r}}const ce=t=>{const l=typeof t=="number"?t:Number(t);return Number.isFinite(l)?l:null};function H(t,l){if(!t)return null;for(const a of l){const r=ce(t[a]);if(r!==null)return r}return null}function Je(t){return t==="large"?{pe:{low:12,base:16,high:22},pfcf:{low:12,base:16,high:22},ps:{low:1,base:1.5,high:2},pb:{low:1,base:1.4,high:1.9}}:t==="mid"?{pe:{low:10,base:14,high:18},pfcf:{low:10,base:14,high:18},ps:{low:.8,base:1.2,high:1.6},pb:{low:.8,base:1.2,high:1.6}}:{pe:{low:8,base:12,high:16},pfcf:{low:8,base:12,high:16},ps:{low:.5,base:1,high:1.5},pb:{low:.7,base:1,high:1.3}}}function Z(t){return t==null?null:Math.round(t*100)/100}function Ke(t){var C,A;const l=[],a=t.metric??{},r=ce(t.price),n=Math.max(0,Math.min(.9,((C=t.options)==null?void 0:C.marginOfSafety)??.3)),p=Math.max(1,Math.min(20,((A=t.options)==null?void 0:A.riskCapMultiple)??5));if(r==null||r<=0)return{blended:null,methods:[],mos:{threshold:n,pass:null},warnings:["Price is missing — cannot compute valuation."],altCalcs:[],compositeAverage:null};const c=t.category??null,x=Je(c),y=H(a,["peTTM","peInclExtraTTM","peExclExtraTTM","peBasicExclExtraTTM"]),s=H(a,["psTTM","psAnnual"]),b=H(a,["pb","priceToBookAnnual","ptbvQuarterly","ptbvAnnual"]),o=H(a,["pfcfShareTTM","pfcfShareAnnual"]),g=H(a,["netProfitMarginTTM","netMarginAnnual","netProfitMargin5Y"]),M=H(a,["roeTTM","roeAnnual"]),B=H(a,["revenueGrowthTTMYoy","revenueGrowthQuarterlyYoy"]),u=H(a,["52WeekPriceReturnDaily","yearToDatePriceReturnDaily"]),R=H(a,["beta"]);let _=!1;const v={pe:{...x.pe},pfcf:{...x.pfcf},ps:{...x.ps},pb:{...x.pb}};g!=null&&g<0&&(v.pe.low*=.5,v.pe.base*=.5,v.pe.high*=.5,v.pfcf.low*=.5,v.pfcf.base*=.5,v.pfcf.high*=.5,l.push("Negative net margin — downshifted PE/PFCF targets.")),M!=null&&M<5&&(v.pb.low*=.7,v.pb.base*=.7,v.pb.high*=.7,l.push("Low ROE — downshifted PB targets.")),B!=null&&B<0&&(v.ps.low*=.75,v.ps.base*=.75,v.ps.high*=.75,l.push("Negative revenue growth — downshifted PS targets.")),(u!=null&&u<=-90||R!=null&&R>2.2)&&(_=!0,l.push("High-risk profile (52w drawdown or high beta)."));const P=(h,G)=>h==null||!Number.isFinite(h)||h<=0?null:Z(r*(G/h)),f=[y!=null?{key:"pe",available:!0,low:P(y,v.pe.low),base:P(y,v.pe.base),high:P(y,v.pe.high)}:{key:"pe",available:!1},o!=null?{key:"pfcf",available:!0,low:P(o,v.pfcf.low),base:P(o,v.pfcf.base),high:P(o,v.pfcf.high)}:{key:"pfcf",available:!1},s!=null?{key:"ps",available:!0,low:P(s,v.ps.low),base:P(s,v.ps.base),high:P(s,v.ps.high)}:{key:"ps",available:!1},b!=null?{key:"pb",available:!0,low:P(b,v.pb.low),base:P(b,v.pb.base),high:P(b,v.pb.high)}:{key:"pb",available:!1}],S=Object.fromEntries(f.map(h=>[h.key,h.available]));let N={};S.pfcf&&S.pe?N={pfcf:.45,pe:.3,pb:.15,ps:.1}:S.pfcf&&!S.pe?N={pfcf:.6,ps:.25,pb:.15}:!S.pfcf&&S.pe?N={pe:.55,pb:.3,ps:.15}:(S.ps||S.pb)&&(N={ps:.6,pb:.4});let O=0;for(const h of Object.keys(N))S[h]?O+=N[h]:delete N[h];for(const h of Object.keys(N))N[h]=N[h]/O;const F=h=>{if(!O)return null;let G=0;for(const D of f){if(!D.available||D[h]==null)continue;const L=N[D.key]??0;G+=D[h]*L}return Z(G)};let k={low:F("low"),base:F("base"),high:F("high")};const U=h=>{const G=f.filter(L=>L.available&&L[h]!=null).map(L=>L[h]);if(!G.length)return null;const D=G.reduce((L,de)=>L+de,0)/G.length;return Z(D)},z=()=>U("low");f.find(h=>h.key==="pe");const I=f.find(h=>h.key==="ps"),$=f.find(h=>h.key==="pb"),w=[];w.push({key:"blend",label:"Multiples Blend (cap-size targets)",source:"Price × (TargetMultiple / CurrentMultiple) blended across P/FCF, P/E, P/S, P/B; targets by market-cap band with risk downshifts and sanity cap.",available:k.base!=null,low:k.low,base:k.base,high:k.high}),w.push({key:"equal_weight",label:"Equal-Weight Multiples",source:"Average of Price × (Target/Current) across available multiples (PE, PFCF, PS, PB).",available:U("base")!=null,low:U("low"),base:U("base"),high:U("high")});const m=z();if(w.push({key:"downside",label:"Downside (Low Targets)",source:"Average of *low* target prices across available multiples; conservative case.",available:m!=null,low:m,base:m,high:m}),w.push({key:"pb_only",label:"PB-only (ROE-tuned)",source:"Price × (TargetPB / CurrentPB), with TargetPB reduced when ROE < 5%.",available:!!($!=null&&$.available&&$.base!=null),low:($==null?void 0:$.low)??null,base:($==null?void 0:$.base)??null,high:($==null?void 0:$.high)??null}),w.push({key:"ps_only",label:"PS-only (Margin-tuned)",source:"Price × (TargetPS / CurrentPS), with TargetPS reduced when margins/growth are weak.",available:!!(I!=null&&I.available&&I.base!=null),low:(I==null?void 0:I.low)??null,base:(I==null?void 0:I.base)??null,high:(I==null?void 0:I.high)??null}),_){const h=D=>{if(D==null)return null;const L=r*p;return D>L?Z(L):D};k=(D=>({low:h(D.low),base:h(D.base),high:h(D.high)}))(k);for(const D of w)D.low=h(D.low),D.base=h(D.base),D.high=h(D.high);l.push(`High-risk sanity cap applied at ×${p} of current price.`)}const i=k.base!=null?r<=k.base*(1-n):null,E=w.filter(h=>h.available&&h.base!=null).map(h=>h.base),j=E.length?Z(E.reduce((h,G)=>h+G,0)/E.length):null;return{blended:k,methods:f,mos:{threshold:n,pass:i},warnings:l,altCalcs:w,compositeAverage:j}}function Qe(t,l){const a=(t||"").toUpperCase(),r=ee(b=>b.stocks.items.find(o=>o.ticker===a)),n=ee(ie(a)),[p,c]=T.useState(null),[x,y]=T.useState(!1),s=T.useMemo(()=>{const b=[p,l,n==null?void 0:n.price,r==null?void 0:r.price,r==null?void 0:r.prevClose,r==null?void 0:r.open,r==null?void 0:r.high,r==null?void 0:r.low];for(const o of b)if(typeof o=="number"&&Number.isFinite(o)&&o>0)return o;return null},[p,l,n==null?void 0:n.price,r==null?void 0:r.price,r==null?void 0:r.prevClose,r==null?void 0:r.open,r==null?void 0:r.high,r==null?void 0:r.low]);return T.useEffect(()=>{let b=!1;return(async()=>{var o;if(!(s!=null||x||!a))try{y(!0);const g=await te(`/api/fh/snapshot-batch?symbols=${encodeURIComponent(a)}`,{noStore:!0,timeoutMs:12e3}),M=((o=g==null?void 0:g.items)==null?void 0:o[0])||{},B=[M.price,M.prevClose,M.open,M.high,M.low].find(u=>typeof u=="number"&&Number.isFinite(u)&&u>0);!b&&typeof B=="number"&&c(B)}catch{}finally{b||y(!1)}})(),()=>{b=!0}},[s,x,a]),{priceNow:s,fetchingPrice:x,stock:r,seed:n}}const se={};function Xe(t){let l=2166136261;for(let a=0;a<t.length;a++)l^=t.charCodeAt(a),l=Math.imul(l,16777619);return(l>>>0).toString(16)}const Ze=360*60*1e3,re=typeof import.meta<"u"&&(se==null?void 0:se.VITE_DISABLE_GPT)==="1",et=({symbol:t,priceNow:l,category:a,metric:r,valuation:n})=>{const[p,c]=T.useState(!1),[x,y]=T.useState(!1),[s,b]=T.useState(null),[o,g]=T.useState(null);function M(u){return u.includes("OPENAI_API_KEY not set")?"ChatGPT не настроен: добавьте OPENAI_API_KEY в переменные окружения сервера и перезапустите.":/429/.test(u)&&/quota/i.test(u)?"ChatGPT: исчерпана квота аккаунта OpenAI (нужна оплата/кредиты в Billing).":/429/.test(u)?"ChatGPT: слишком часто. Запрос ограничен со стороны сервера.":u}async function B(){if(!x){y(!0),b(null);try{if(re)throw new Error("ChatGPT временно отключён админ-флагом (VITE_DISABLE_GPT=1).");const u=r||{},R={pe:u.peTTM??u.peInclExtraTTM??u.peExclExtraTTM??null,pfcf:u.pfcfShareTTM??u.pfcfShareAnnual??null,ps:u.psTTM??u.psAnnual??null,pb:u.pb??u.ptbvQuarterly??u.ptbvAnnual??null,grossMargin:u.grossMarginTTM??null,netMargin:u.netProfitMarginTTM??null,roe:u.roeTTM??null,roic:u.roicTTM??null,revGyoy:u.revenueGrowthTTMYoy??null,beta:u.beta??null,debtToEquity:u.debtToEquityTTM??u.debtToEquityAnnual??null,currentRatio:u.currentRatioTTM??u.currentRatioAnnual??null},_={symbol:t,priceNow:l,category:a,metric:R,valuation:{blended:n.blended,compositeAverage:n.compositeAverage,altCalcs:n.altCalcs.map(k=>({label:k.label,low:k.low??null,base:k.base??null,high:k.high??null})),warnings:n.warnings}},v=`LLM:${t}:${Xe(JSON.stringify({s:t,p:l,c:a,m:R,v:_.valuation}))}`,P=window.sessionStorage,f=P.getItem(v);if(f){const k=JSON.parse(f);if(k.exp>Date.now()&&k.text){g(k.text),c(!0),y(!1);return}else P.removeItem(v)}const S=await fetch("/api/llm/commentary",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(_)}),N=await S.text().catch(()=>"");if(!S.ok)throw new Error(`${S.status} ${S.statusText}${N?` — ${N}`:""}`);const{commentary:O}=JSON.parse(N),F=O||"No commentary received.";g(F),P.setItem(v,JSON.stringify({text:F,exp:Date.now()+Ze})),c(!0)}catch(u){b(M(String((u==null?void 0:u.message)||u)))}finally{y(!1)}}}return e.jsxs("div",{style:{marginTop:12},children:[e.jsx("button",{className:d.viewButton,style:{padding:"0.45rem 0.9rem"},onClick:B,disabled:x,title:re?"ChatGPT отключён (env flag)":"Отправить текущие метрики и оценки в ChatGPT для комментария",children:x?"Asking ChatGPT…":re?"ChatGPT disabled":"Show ChatGPT commentary"}),s?e.jsxs("p",{className:d.errorText,style:{marginTop:8},children:["ChatGPT error: ",s]}):null,p&&o?e.jsxs("div",{className:d.rawTableWrap,style:{marginTop:8,padding:12},children:[e.jsx("div",{className:d.muted,style:{marginBottom:6},children:"AI commentary (not investment advice):"}),e.jsx("div",{style:{whiteSpace:"pre-wrap",lineHeight:1.4},children:o})]}):null]})};function J(t){return t==null||!Number.isFinite(t)?"—":`$${t.toFixed(2)}`}const tt=({symbol:t,metric:l,metricsLoading:a,priceSeed:r})=>{var N,O,F,k,U,z,I,$,w;const{priceNow:n,fetchingPrice:p,stock:c,seed:x}=Qe(t,r),y=(x==null?void 0:x.category)??(c==null?void 0:c.category)??null,[s,b]=T.useState(!1),[o,g]=T.useState(null),[M,B]=T.useState(null),u=T.useMemo(()=>a?"Metrics are still loading…":l?n==null?p?"Fetching price snapshot…":"No price/OHLC snapshot yet":null:"Metrics not loaded yet",[a,l,n,p]),R=!u,_=T.useCallback(()=>{if(!(!R||s)){b(!0),B(null);try{const m=Ke({price:n,category:y,metric:l,options:{marginOfSafety:.3,riskCapMultiple:5}});g(m)}catch(m){B(String((m==null?void 0:m.message)||m)),g(null)}finally{b(!1)}}},[R,s,n,y,l]),v=T.useMemo(()=>{var E;if(!((E=o==null?void 0:o.blended)!=null&&E.base)||!n)return"—";const m=(o.blended.base-n)/n,i=Math.abs(m*100).toFixed(2)+"%";return m>=0?`Discount ${i}`:`Premium ${i}`},[(N=o==null?void 0:o.blended)==null?void 0:N.base,n]),P=T.useMemo(()=>{if(!(o!=null&&o.compositeAverage)||!n)return"—";const m=(o.compositeAverage-n)/n,i=Math.abs(m*100).toFixed(2)+"%";return m>=0?`Discount ${i}`:`Premium ${i}`},[o==null?void 0:o.compositeAverage,n]),f=n?n*5:null,S=m=>f!=null&&typeof m=="number"&&Math.abs(m-f)<.005;return e.jsxs("div",{className:d.fvCard,children:[e.jsxs("div",{className:d.fvHeader,children:[e.jsx("h4",{className:d.fvTitle,children:"Fair Value (ratio-based)"}),e.jsx("button",{onClick:_,disabled:!R||s,className:d.viewButton,style:{padding:"0.45rem 0.9rem"},title:R?"Compare Fair Value with current price":u??"",children:s?"Computing…":"Compare Fair Value"})]}),!R&&e.jsx("p",{className:d.muted,style:{marginTop:4},children:u}),!o&&!M&&R&&e.jsx("p",{className:d.muted,children:"Uses current multiples (P/E, P/FCF, P/S, P/B) → target ranges by size band with risk downshifts & sanity caps."}),M?e.jsxs("p",{className:d.errorText,children:["Valuation error: ",M]}):null,o?e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:d.muted,style:{marginTop:4},children:[e.jsx("strong",{children:"Source:"})," Price × (TargetMultiple / CurrentMultiple), blended across available multiples; targets depend on market-cap band; risk downshifts (neg. margin, low ROE, neg. growth) and a high-risk sanity cap."]}),e.jsxs("div",{className:d.fvGrid,children:[e.jsxs("div",{className:d.kpi,children:[e.jsx("div",{className:d.kpiTitle,children:"Price (now)"}),e.jsx("div",{className:d.kpiValue,children:J(n)})]}),e.jsxs("div",{className:d.kpi,children:[e.jsx("div",{className:d.kpiTitle,children:"Fair Value (base)"}),e.jsxs("div",{className:d.kpiValue,children:[J(((O=o.blended)==null?void 0:O.base)??null),S((F=o.blended)==null?void 0:F.base)?" (capped ×5)":""]}),((k=o.blended)==null?void 0:k.low)!=null&&((U=o.blended)==null?void 0:U.high)!=null?e.jsxs("div",{className:d.kpiSub,children:["Low ",J(o.blended.low)," · High ",J(o.blended.high)]}):null]}),e.jsxs("div",{className:d.kpi,children:[e.jsx("div",{className:d.kpiTitle,children:"Discount / Premium"}),e.jsx("div",{className:d.kpiValue,children:v})]}),e.jsxs("div",{className:d.kpi,children:[e.jsx("div",{className:d.kpiTitle,children:"MoS (30%) Pass"}),e.jsx("div",{className:d.kpiValue,children:((z=o.mos)==null?void 0:z.pass)==null?"—":o.mos.pass?"YES":"NO"}),((I=o.mos)==null?void 0:I.threshold)!=null&&(($=o.blended)==null?void 0:$.base)!=null?e.jsxs("div",{className:d.kpiSub,children:["Threshold: ",J(o.blended.base*(1-o.mos.threshold))]}):null]})]}),e.jsxs("details",{className:d.rawBlock,open:!0,children:[e.jsx("summary",{className:d.rawSummary,children:"Calculators (side-by-side)"}),e.jsx("div",{className:d.rawTableWrap,children:e.jsxs("table",{className:d.metricsTable,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Calculator"}),e.jsx("th",{children:"Low"}),e.jsx("th",{children:"Base"}),e.jsx("th",{children:"High"}),e.jsx("th",{children:"Source"})]})}),e.jsx("tbody",{children:o.altCalcs.map((m,i)=>e.jsxs("tr",{children:[e.jsx("td",{className:d.keyCell,children:m.label}),e.jsx("td",{className:d.valCell,children:J(m.low??null)}),e.jsxs("td",{className:d.valCell,children:[J(m.base??null),S(m.base??null)?" (capped ×5)":""]}),e.jsx("td",{className:d.valCell,children:J(m.high??null)}),e.jsx("td",{className:d.valCell,children:e.jsx("span",{className:d.muted,children:m.source})})]},i))})]})})]}),e.jsxs("div",{className:d.fvGrid,style:{marginTop:8},children:[e.jsxs("div",{className:d.kpi,children:[e.jsx("div",{className:d.kpiTitle,children:"Composite Average (across calculators)"}),e.jsx("div",{className:d.kpiValue,children:J(o.compositeAverage)})]}),e.jsxs("div",{className:d.kpi,children:[e.jsx("div",{className:d.kpiTitle,children:"Discount / Premium vs Average"}),e.jsx("div",{className:d.kpiValue,children:P})]})]}),(w=o.warnings)!=null&&w.length?e.jsxs("details",{className:d.rawBlock,open:!0,children:[e.jsx("summary",{className:d.rawSummary,children:"Warnings & assumptions"}),e.jsx("ul",{style:{margin:"0.25rem 0 0 1rem"},children:o.warnings.map((m,i)=>e.jsxs("li",{className:d.muted,children:["• ",m]},i))})]}):null,e.jsx(et,{symbol:t,priceNow:n,category:y,metric:l,valuation:o})]}):null]})},nt=({symbol:t,metric:l,metricsLoading:a,priceSeed:r})=>{const n=l?He(l):null;return e.jsxs("div",{className:d.aboutCard,children:[e.jsx("h3",{children:"About the Company"}),e.jsx("p",{style:{opacity:.8},children:"No long description available."}),n?e.jsxs("div",{style:{marginTop:"0.5rem"},children:[!!n.strengths.length&&e.jsx("ul",{style:{margin:"0.25rem 0"},children:n.strengths.map((p,c)=>e.jsxs("li",{children:["✅ ",p]},"s"+c))}),!!n.risks.length&&e.jsx("ul",{style:{margin:"0.25rem 0"},children:n.risks.map((p,c)=>e.jsxs("li",{children:["⚠️ ",p]},"r"+c))}),!!n.notes.length&&e.jsx("p",{style:{marginTop:6},children:n.notes.join(" ")})]}):null,e.jsx(tt,{symbol:t,metric:l,metricsLoading:a,priceSeed:r})]})};function st({symbol:t}){var n,p,c,x;const l=ae(),a=ee(he(t)),r=T.useCallback(()=>{l(oe({symbol:t,lookbackDays:14,limit:20}))},[l,t]);return e.jsxs("div",{style:{background:"var(--card-bg, #fff)",borderRadius:12,boxShadow:"var(--shadow, 0 2px 12px rgba(0,0,0,.08))",padding:16},children:[e.jsxs("div",{style:{display:"flex",alignItems:"baseline",gap:8},children:[e.jsx("h3",{style:{margin:0,fontSize:18,fontWeight:600},children:"Key Insights (last 14 days)"}),e.jsx("button",{onClick:r,disabled:a.status==="loading",style:{marginLeft:"auto",padding:"6px 10px",borderRadius:8,border:"1px solid var(--border, #ddd)",background:"transparent",cursor:a.status==="loading"?"not-allowed":"pointer"},"aria-busy":a.status==="loading",children:a.status==="loading"?"Loading…":"Refresh"})]}),e.jsx("div",{style:{marginTop:8},children:a.status==="loading"&&!((n=a.items)!=null&&n.length)?e.jsx(q,{count:3,height:14,style:{marginBottom:6}}):(p=a==null?void 0:a.insights)!=null&&p.length?e.jsx("ul",{style:{margin:"8px 0 0",paddingLeft:18},children:a.insights.slice(0,7).map((y,s)=>e.jsx("li",{style:{marginBottom:6},children:y},s))}):e.jsx("div",{style:{color:"var(--muted, #666)",fontSize:14},children:"No key insights available."})}),e.jsx("h4",{style:{marginTop:16,marginBottom:8,fontSize:16,fontWeight:600},children:"Headlines"}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:8},children:a.status==="loading"&&!((c=a.items)!=null&&c.length)?e.jsxs(e.Fragment,{children:[e.jsx(q,{height:18}),e.jsx(q,{height:18}),e.jsx(q,{height:18})]}):(x=a.items)!=null&&x.length?a.items.slice(0,20).map(y=>{var s;return e.jsxs("a",{href:y.url,target:"_blank",rel:"noreferrer noopener",style:{textDecoration:"none",border:"1px solid var(--border, #eee)",borderRadius:10,padding:10},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx("span",{style:{fontSize:12,padding:"2px 6px",borderRadius:6,border:"1px solid #ddd",textTransform:"capitalize"},children:y.sentiment}),(s=y.tags)!=null&&s.length?e.jsx("span",{style:{fontSize:12,color:"var(--muted, #666)"},children:y.tags.join(" · ")}):null,e.jsx("span",{style:{marginLeft:"auto",fontSize:12,color:"var(--muted, #666)"},children:new Date(y.publishedAt).toLocaleString()})]}),e.jsx("div",{style:{marginTop:6,fontWeight:600},children:y.title}),e.jsx("div",{style:{marginTop:4,fontSize:12,color:"var(--muted, #666)"},children:y.source})]},y.id)}):e.jsx("div",{style:{color:"var(--muted, #666)",fontSize:14},children:"No recent headlines."})}),a.status==="failed"&&a.error?e.jsxs("div",{style:{marginTop:10,color:"#b00020"},children:["Error: ",a.error]}):null]})}async function rt(t){const l=new URLSearchParams;return l.set("symbol",t.symbol.toUpperCase()),t.fromISO&&l.set("from",t.fromISO),t.toISO&&l.set("to",t.toISO),t.res&&l.set("res",t.res),t.provider&&l.set("provider",t.provider),te(`/api/candles?${l.toString()}`,{noStore:!0,timeoutMs:25e3})}function lt(t,l=!0){let a=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY;for(const p of t){const c=l?p.l:p.c,x=l?p.h:p.c;c<a&&(a=c),x>r&&(r=x)}if(!Number.isFinite(a)||!Number.isFinite(r))return{minY:0,maxY:1};if(a===r){const p=a===0?1:Math.abs(a)*.05;return{minY:a-p,maxY:r+p}}const n=(r-a)*.05;return{minY:a-n,maxY:r+n}}function it(t){const[l,a]=T.useState({w:0,h:0});return T.useEffect(()=>{const r=t.current;if(!r)return;const n=new ResizeObserver(p=>{for(const c of p){const x=c.contentRect;a({w:Math.max(100,Math.floor(x.width)),h:Math.max(180,Math.floor(x.height))})}});return n.observe(r),()=>n.disconnect()},[t]),l}function ne(t){try{return new Intl.NumberFormat(void 0,{style:"currency",currency:"USD",maximumFractionDigits:t<1?4:2}).format(t)}catch{return`$${t.toFixed(2)}`}}function at(t){return new Date(t*1e3).toISOString().slice(0,10)}function ot({symbol:t,fromISO:l,toISO:a}){var O,F,k,U,z,I,$;const{t:r}=le(),[n,p]=T.useState({data:null,loading:!0});T.useEffect(()=>{let w=!0;const m=new Date,i=l??new Date(new Date(m).setFullYear(m.getFullYear()-20)).toISOString().slice(0,10),E=a??m.toISOString().slice(0,10);return(async()=>{try{const j=await rt({symbol:t,fromISO:i,toISO:E,res:"D",adjusted:!0,provider:"both"});if(!w)return;p({data:j,loading:!1})}catch(j){if(!w)return;p({data:null,error:String((j==null?void 0:j.message)||j),loading:!1})}})(),()=>{w=!1}},[t,l,a]);const c=T.useRef(null),x=T.useRef(null),y=T.useRef(null),{w:s,h:b}=it(c),o=((O=n.data)==null?void 0:O.items)??[],g=((F=n.data)==null?void 0:F.consensus)??[],M=o.length?o[0].t:0,B=o.length?o[o.length-1].t:1,{minY:u,maxY:R}=lt(o,!0),_=w=>B===M?0:(w-M)/(B-M)*(s-40)+30,v=w=>R===u?0:(1-(w-u)/(R-u))*(b-60)+20;T.useEffect(()=>{const w=x.current;if(!w||!s||!b)return;const m=window.devicePixelRatio||1;w.width=Math.floor(s*m),w.height=Math.floor(b*m),w.style.width=`${s}px`,w.style.height=`${b}px`;const i=w.getContext("2d");if(!i)return;i.scale(m,m),i.clearRect(0,0,s,b),i.strokeStyle="rgba(0,0,0,0.06)",i.lineWidth=1,i.beginPath();for(let j=0;j<=4;j++){const C=20+j*(b-60)/4;i.moveTo(30,C),i.lineTo(s-10,C)}if(i.stroke(),!o.length)return;i.strokeStyle="rgba(0,0,0,0.18)",i.lineWidth=1,i.beginPath();for(let j=0;j<o.length;j++){const C=o[j],A=_(C.t),h=v(C.h),G=v(C.l);i.moveTo(A,h),i.lineTo(A,G)}i.stroke(),i.beginPath();for(let j=0;j<o.length;j++){const C=o[j],A=_(C.t),h=v(C.c);j===0?i.moveTo(A,h):i.lineTo(A,h)}i.lineWidth=1.6,i.strokeStyle="rgba(0,0,0,0.8)",i.stroke();const E=i.createLinearGradient(0,20,0,b-40);E.addColorStop(0,"rgba(0,0,0,0.08)"),E.addColorStop(1,"rgba(0,0,0,0.00)"),i.fillStyle=E,i.beginPath();for(let j=0;j<o.length;j++){const C=o[j],A=_(C.t),h=v(C.c);j===0?i.moveTo(A,h):i.lineTo(A,h)}if(i.lineTo(_(o[o.length-1].t),b-40),i.lineTo(_(o[0].t),b-40),i.closePath(),i.fill(),g.length>=5){i.beginPath();for(let j=0;j<g.length;j++){const C=g[j],A=_(C.t),h=v(C.c);j===0?i.moveTo(A,h):i.lineTo(A,h)}i.lineWidth=1,i.setLineDash([4,4]),i.strokeStyle="rgba(0,0,0,0.5)",i.stroke(),i.setLineDash([])}},[o,g,s,b,u,R]);const[P,f]=T.useState(null);T.useEffect(()=>{const w=y.current;if(!w||!s||!b)return;const m=window.devicePixelRatio||1;w.width=Math.floor(s*m),w.height=Math.floor(b*m),w.style.width=`${s}px`,w.style.height=`${b}px`;const i=w.getContext("2d");if(!i||(i.scale(m,m),i.clearRect(0,0,s,b),!P||!o.length))return;const E=P.idx,j=o[E],C=_(j.t),A=v(j.c);i.strokeStyle="rgba(0,0,0,0.3)",i.lineWidth=1,i.beginPath(),i.moveTo(C,15),i.lineTo(C,b-45),i.moveTo(25,A),i.lineTo(s-10,A),i.stroke(),i.fillStyle="rgba(0,0,0,0.8)",i.beginPath(),i.arc(C,A,2.5,0,Math.PI*2),i.fill();const h=`${at(j.t)}  O:${ne(j.o)}  H:${ne(j.h)}  L:${ne(j.l)}  C:${ne(j.c)}`;i.font="12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";const G=Math.min(s-40,i.measureText(h).width+16),D=Math.min(Math.max(C+8,30),s-G-10),L=Math.max(22,A-36);i.fillStyle="rgba(255,255,255,0.95)",i.strokeStyle="rgba(0,0,0,0.08)",i.lineWidth=1,i.beginPath(),i.roundRect(D,L,G,28,8),i.fill(),i.stroke(),i.fillStyle="rgba(0,0,0,0.85)",i.fillText(h,D+8,L+18)},[P,o,s,b,u,R]);const S=w=>{if(!o.length)return;const m=w.target.getBoundingClientRect(),i=w.clientX-m.left,E=M+(i-30)/Math.max(1,s-40)*(B-M);let j=0,C=o.length-1;for(;j<C;){const h=j+C>>1;o[h].t<E?j=h+1:C=h}const A=Math.max(0,Math.min(o.length-1,j));f({idx:A,x:i,y:0})},N=()=>f(null);return e.jsxs("div",{className:d.chartCard,children:[e.jsx("h3",{children:r("stockDetails.chart")}),e.jsxs("div",{ref:c,style:{position:"relative",width:"100%",height:320},children:[n.loading&&e.jsxs("div",{className:d.chartPlaceholder,children:["(",r("stockDetails.chartPlaceholder"),")"]}),n.error&&e.jsx("div",{className:d.chartPlaceholder,style:{color:"crimson"},children:n.error}),!n.loading&&!n.error&&!o.length&&e.jsx("div",{className:d.chartPlaceholder,children:r("common.noData")||"No data"}),e.jsx("canvas",{ref:x,style:{position:"absolute",inset:0}}),e.jsx("canvas",{ref:y,onMouseMove:S,onMouseLeave:N,style:{position:"absolute",inset:0}}),!n.loading&&o.length>0&&e.jsxs("div",{style:{position:"absolute",left:30,right:10,bottom:6,display:"flex",justifyContent:"space-between",fontSize:12,opacity:.7},children:[e.jsx("span",{children:(U=(k=n.data)==null?void 0:k.meta)==null?void 0:U.fromISO}),e.jsx("span",{children:(I=(z=n.data)==null?void 0:z.meta)==null?void 0:I.toISO})]})]}),!!(($=n.data)!=null&&$.stats)&&e.jsxs("div",{style:{marginTop:8,fontSize:12,opacity:.7},children:[r("stockDetails.coverage")||"Coverage",": overlap ",n.data.stats.overlap??0]})]})}const ut=()=>{var P;const{t}=le(),{ticker:l}=ue(),a=fe(),r=ae(),n=(l||"").toUpperCase(),p=ee(f=>f.stocks.items.find(S=>S.ticker===n)),c=ee(ie(n)),x=(P=a.state)==null?void 0:P.seed,y=(x==null?void 0:x.price)??(c==null?void 0:c.price)??(p==null?void 0:p.price)??null,s=(x==null?void 0:x.category)??(c==null?void 0:c.category)??(p==null?void 0:p.category)??null;T.useEffect(()=>{n&&r(pe({ticker:n}))},[n,r]);const{loading:b,error:o,metric:g}=Ge(n),{loading:M,error:B,profile:u}=Le(n),{error:R,facts:_}=Ve(n),v=T.useMemo(()=>{const f=((u==null?void 0:u.name)??"").trim(),S=((p==null?void 0:p.name)??"").trim(),N=((_==null?void 0:_.entityName)??"").trim();return f||S||N||null},[u==null?void 0:u.name,p==null?void 0:p.name,_==null?void 0:_.entityName]);return T.useEffect(()=>{n&&r(oe({symbol:n,lookbackDays:14,limit:20}))},[n,r]),e.jsxs(xe.div,{className:d.wrapper,initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:[e.jsx("h1",{className:d.title,children:n?`${v??t("stockDetails.namePlaceholder")} (${n})`:e.jsx(q,{width:300})}),e.jsxs("div",{className:d.grid,children:[e.jsx(ze,{symbol:n,priceSeed:y,categorySeed:s,metric:g,metricsLoading:b,metricsError:o,p2:u,p2Loading:M,p2Error:B,secFacts:_,secError:R}),e.jsxs("div",{children:[e.jsx(ot,{symbol:n}),e.jsx("div",{style:{marginTop:16},children:e.jsx(st,{symbol:n})})]})]}),e.jsx(qe,{metric:g,loading:b,error:o}),e.jsx(nt,{symbol:n,metric:g,metricsLoading:b,priceSeed:y})]})};export{ut as StockDetails,ut as default};
