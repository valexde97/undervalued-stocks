import{r as T,f as ee,u as le,j as e,d as X,m as re,a as ie,n as de,o as ae,c as ue,p as he,q as pe}from"./index-Bz-nO7ji.js";import{S as V}from"./skeleton-_aCiaNjp.js";import{m as fe}from"./proxy-CsM7G8xT.js";const xe="_wrapper_1lbh8_1",me="_title_1lbh8_9",ge="_grid_1lbh8_16",be="_infoCard_1lbh8_23",je="_chartCard_1lbh8_23",Te="_aboutCard_1lbh8_23",ye="_table_1lbh8_31",ve="_subhead_1lbh8_42",we="_chartPlaceholder_1lbh8_52",Me="_fvCard_1lbh8_64",Ne="_fvHeader_1lbh8_65",ke="_fvTitle_1lbh8_66",Se="_fvGrid_1lbh8_68",Ce="_kpi_1lbh8_69",Pe="_kpiTitle_1lbh8_70",Ee="_kpiValue_1lbh8_71",_e="_kpiSub_1lbh8_72",Ae="_muted_1lbh8_74",Be="_rawBlock_1lbh8_77",$e="_rawSummary_1lbh8_81",De="_rawTableWrap_1lbh8_91",Ie="_metricsTable_1lbh8_99",Fe="_keyCell_1lbh8_119",Re="_valCell_1lbh8_125",Ue="_errorText_1lbh8_131",a={wrapper:xe,title:me,grid:ge,infoCard:be,chartCard:je,aboutCard:Te,table:ye,subhead:ve,chartPlaceholder:we,fvCard:Me,fvHeader:Ne,fvTitle:ke,fvGrid:Se,kpi:Ce,kpiTitle:Pe,kpiValue:Ee,kpiSub:_e,muted:Ae,rawBlock:Be,rawSummary:$e,rawTableWrap:De,metricsTable:Ie,keyCell:Fe,valCell:Re,errorText:Ue};function Ge(s){const[l,i]=T.useState(!0),[r,t]=T.useState(null),[f,o]=T.useState(null);return T.useEffect(()=>{let h=!1;async function m(){if(s){i(!0),t(null);try{const n=await ee(`/api/fh/metrics?symbol=${encodeURIComponent(s)}`,{noStore:!0,timeoutMs:2e4});h||o((n==null?void 0:n.metric)??{})}catch(n){h||t(String((n==null?void 0:n.message)||n))}finally{h||i(!1)}}}return m(),()=>{h=!0}},[s]),{loading:l,error:r,metric:f}}function Oe(s){const[l,i]=T.useState(!0),[r,t]=T.useState(null),[f,o]=T.useState(null);return T.useEffect(()=>{let h=!1;async function m(){if(s){i(!0),t(null);try{const n=await ee(`/api/fh/profile2?symbol=${encodeURIComponent(s)}`,{noStore:!0,timeoutMs:15e3});h||o((n==null?void 0:n.profile)??null)}catch(n){h||t(String((n==null?void 0:n.message)||n))}finally{h||i(!1)}}}return m(),()=>{h=!0}},[s]),{loading:l,error:r,profile:f}}function Le(s){const[l,i]=T.useState(!0),[r,t]=T.useState(null),[f,o]=T.useState(null);return T.useEffect(()=>{let h=!1;async function m(){if(s){i(!0),t(null);try{const n=await ee(`/api/sec/company-facts?symbol=${encodeURIComponent(s)}`,{noStore:!0,timeoutMs:2e4});h||o(n??null)}catch(n){h||t(String((n==null?void 0:n.message)||n))}finally{h||i(!1)}}}return m(),()=>{h=!0}},[s]),{loading:l,error:r,facts:f}}function G(s){return typeof s!="number"||!Number.isFinite(s)?"—":Math.abs(s)>=1e12?(s/1e12).toFixed(2)+"T":Math.abs(s)>=1e9?(s/1e9).toFixed(2)+"B":Math.abs(s)>=1e6?(s/1e6).toFixed(2)+"M":Math.abs(s)>=1e3?(s/1e3).toFixed(2)+"K":s.toFixed(2)}function R(s){const l=typeof s=="number"?s:Number(s);return Number.isFinite(l)?Math.abs(l)>=100?l.toFixed(0):l.toFixed(2):String(s??"—")}function U(s,l){if(!s)return null;for(const i of l){const r=s[i];if(typeof r=="number"&&Number.isFinite(r))return r}return null}function Ve(s){if(!s)return"—";const l=String(s).toLowerCase();return l.charAt(0).toUpperCase()+l.slice(1)}const qe=({symbol:s,priceSeed:l,categorySeed:i,metric:r,metricsLoading:t,metricsError:f,p2:o,p2Loading:h,p2Error:m,secFacts:n,secError:v})=>{var u,_,E,b,N;const{t:c}=le(),p=T.useMemo(()=>{const d=r||{},j=U(d,["peTTM","peInclExtraTTM","peExclExtraTTM","peAnnual","peBasicExclExtraTTM"]),y=U(d,["psTTM","psAnnual"]),I=U(d,["pb","priceToBookAnnual"]),D=U(d,["pegAnnual","pegRatio"]),M=U(d,["enterpriseValueOverEBITDA","evebitdaAnnual"]),F=U(d,["roeTTM","roeAnnual"]),q=U(d,["roicTTM","roicAnnual"]),k=U(d,["grossMarginTTM","grossMarginAnnual"]),S=U(d,["netProfitMarginTTM","netMarginAnnual"]),A=U(d,["debtToEquityAnnual","debtToEquityTTM"]),g=U(d,["currentRatioAnnual","currentRatioTTM"]),P=U(d,["marketCapitalization"]),B=U(d,["sharesBasic"]);return{pe:j,ps:y,pb:I,peg:D,evEbitda:M,roe:F,roic:q,grossMargin:k,netMargin:S,dToE:A,currentRatio:g,marketCap:P,shares:B}},[r]),w=T.useMemo(()=>{const d=r||{},j=H=>typeof H=="number"&&Number.isFinite(H)?H:null,y=j(d.marketCapitalization??p.marketCap),I=j(d.enterpriseValue),D=j(d.totalDebt),M=j(d.totalCash??d.totalCashAndEquivalents??(d==null?void 0:d.cashAndEq)),F=j(d.operatingCashFlowTTM??(d==null?void 0:d.operatingCfTTM)),q=j(d.capitalExpenditureTTM??(d==null?void 0:d.capexTTM)),k=j((d==null?void 0:d.pfcfShareTTM)??(d==null?void 0:d.pfcfShareAnnual)),S=typeof l=="number"&&Number.isFinite(l)?l:null,A=j(p.shares)??j(o==null?void 0:o.shareOutstanding);let g=null,P=null;D!=null&&M!=null?(g=D-M,y!=null&&(P=y+g)):I!=null&&y!=null&&(P=I,g=P-y);let B=null;F!=null&&q!=null?B=F-q:S!=null&&k!=null&&k>0&&A!=null&&A>0&&(B=S/k*A);const se=B!=null&&y!=null&&y>0?B/y:null,Z=B!=null&&B!==0&&P!=null?P/B:null;return{netDebt:g,ev:P,fcf:B,fcfYield:se,evPerFcf:Z}},[r,p.marketCap,p.shares,o==null?void 0:o.shareOutstanding,l]),$=(n==null?void 0:n.entityName)||null;return e.jsxs("div",{className:a.infoCard,children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:8},children:[o!=null&&o.logo?e.jsx("img",{src:o.logo,alt:"logo",style:{width:36,height:36,objectFit:"contain"}}):null,e.jsx("h3",{style:{margin:0},children:c("stockDetails.info")})]}),e.jsx("table",{className:a.table,children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("strong",{children:[c("stockDetails.ticker"),":"]})}),e.jsx("td",{children:s})]}),!h&&!o&&$?e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Name:"})}),e.jsx("td",{children:$})]}):null,e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("strong",{children:[c("stockDetails.price"),":"]})}),e.jsx("td",{children:l!=null?`$${R(l)}`:"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("strong",{children:[c("stockDetails.category"),":"]})}),e.jsx("td",{children:i?Ve(i):"—"})]}),h?e.jsxs(e.Fragment,{children:[e.jsx("tr",{children:e.jsx("td",{colSpan:2,children:e.jsx(V,{height:12})})}),e.jsx("tr",{children:e.jsx("td",{colSpan:2,children:e.jsx(V,{height:12})})})]}):m?e.jsx("tr",{children:e.jsxs("td",{colSpan:2,className:a.errorText,children:["FH Profile2 error: ",m]})}):o?e.jsxs(e.Fragment,{children:[o.name&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Name:"})}),e.jsx("td",{children:o.name})]}),o.finnhubIndustry&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Industry:"})}),e.jsx("td",{children:o.finnhubIndustry})]}),(o.exchange||o.country)&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Listing:"})}),e.jsx("td",{children:[o.exchange,o.country].filter(Boolean).join(", ")})]}),o.ipo&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"IPO:"})}),e.jsx("td",{children:o.ipo})]}),typeof o.marketCapitalization=="number"&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Market Cap (FH):"})}),e.jsxs("td",{children:["$",G(o.marketCapitalization)]})]}),typeof o.shareOutstanding=="number"&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Shares Out:"})}),e.jsx("td",{children:G(o.shareOutstanding)})]}),o.weburl&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Website:"})}),e.jsx("td",{children:e.jsx("a",{href:o.weburl,target:"_blank",rel:"noreferrer noopener",children:o.weburl})})]})]}):null,v?e.jsx("tr",{children:e.jsxs("td",{colSpan:2,className:a.errorText,children:["SEC error: ",v]})}):n?e.jsxs(e.Fragment,{children:[(n.entityName||n.cik)&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"SEC Entity:"})}),e.jsx("td",{children:[n.entityName,n.cik?`CIK ${n.cik}`:""].filter(Boolean).join(" — ")})]}),((u=n.revenueUsd)==null?void 0:u.v)!=null&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Revenue (US-GAAP):"})}),e.jsxs("td",{children:["$",G(n.revenueUsd.v),n.revenueUsd.asOf?` (as of ${n.revenueUsd.asOf})`:""," [USD]"]})]}),((_=n.netIncomeUsd)==null?void 0:_.v)!=null&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Net Income (US-GAAP):"})}),e.jsxs("td",{children:["$",G(n.netIncomeUsd.v),n.netIncomeUsd.asOf?` (as of ${n.netIncomeUsd.asOf})`:""," [USD]"]})]}),((E=n.assetsUsd)==null?void 0:E.v)!=null&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Assets (US-GAAP):"})}),e.jsxs("td",{children:["$",G(n.assetsUsd.v),n.assetsUsd.asOf?` (as of ${n.assetsUsd.asOf})`:""," [USD]"]})]}),((b=n.liabilitiesUsd)==null?void 0:b.v)!=null&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Liabilities (US-GAAP):"})}),e.jsxs("td",{children:["$",G(n.liabilitiesUsd.v),n.liabilitiesUsd.asOf?` (as of ${n.liabilitiesUsd.asOf})`:""," [USD]"]})]}),((N=n.shares)==null?void 0:N.v)!=null&&e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Shares (US-GAAP):"})}),e.jsxs("td",{children:["$",G(n.shares.v),n.shares.asOf?` (as of ${n.shares.asOf})`:""," [",n.shares.unit||"shares","]"]})]})]}):null,e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:a.subhead,children:"Key metrics (Finnhub)"})}),t?e.jsxs(e.Fragment,{children:[e.jsx("tr",{children:e.jsx("td",{colSpan:2,children:e.jsx(V,{height:14})})}),e.jsx("tr",{children:e.jsx("td",{colSpan:2,children:e.jsx(V,{height:14})})}),e.jsx("tr",{children:e.jsx("td",{colSpan:2,children:e.jsx(V,{height:14})})})]}):f?e.jsx("tr",{children:e.jsxs("td",{colSpan:2,className:a.errorText,children:["Finnhub error: ",f]})}):e.jsxs(e.Fragment,{children:[e.jsxs("tr",{children:[e.jsx("td",{children:"P/E (TTM):"}),e.jsx("td",{children:p.pe!=null?R(p.pe):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"P/S (TTM):"}),e.jsx("td",{children:p.ps!=null?R(p.ps):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"P/B:"}),e.jsx("td",{children:p.pb!=null?R(p.pb):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"PEG:"}),e.jsx("td",{children:p.peg!=null?R(p.peg):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"EV/EBITDA:"}),e.jsx("td",{children:p.evEbitda!=null?R(p.evEbitda):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"ROE (TTM):"}),e.jsx("td",{children:p.roe!=null?R(p.roe):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"ROIC (TTM):"}),e.jsx("td",{children:p.roic!=null?R(p.roic):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Gross Margin (TTM):"}),e.jsx("td",{children:p.grossMargin!=null?R(p.grossMargin):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Net Margin (TTM):"}),e.jsx("td",{children:p.netMargin!=null?R(p.netMargin):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Debt / Equity:"}),e.jsx("td",{children:p.dToE!=null?R(p.dToE):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Current Ratio:"}),e.jsx("td",{children:p.currentRatio!=null?R(p.currentRatio):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Market Cap:"}),e.jsx("td",{children:p.marketCap!=null?"$"+G(p.marketCap):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Shares (Basic):"}),e.jsx("td",{children:p.shares!=null?G(p.shares):"—"})]}),e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:a.subhead,children:"Valuation helpers"})}),e.jsxs("tr",{children:[e.jsx("td",{children:"Net Debt:"}),e.jsx("td",{children:w.netDebt!=null?"$"+G(w.netDebt):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Enterprise Value (EV):"}),e.jsx("td",{children:w.ev!=null?"$"+G(w.ev):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"FCF (TTM):"}),e.jsx("td",{children:w.fcf!=null?"$"+G(w.fcf):"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"FCF Yield (TTM):"}),e.jsx("td",{children:w.fcfYield!=null?(w.fcfYield*100).toFixed(2)+"%":"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"EV / FCF (TTM):"}),e.jsx("td",{children:w.evPerFcf!=null?R(w.evPerFcf):"—"})]})]})]})})]})};function ze(s){const l=typeof s=="number"?s:Number(s);return Number.isFinite(l)?Math.abs(l)>=100?l.toFixed(0):l.toFixed(2):String(s??"—")}const We=({metric:s,loading:l,error:i})=>e.jsxs("details",{className:a.rawBlock,open:!0,children:[e.jsx("summary",{className:a.rawSummary,children:"All metrics (raw)"}),e.jsx("div",{className:a.rawTableWrap,children:l?e.jsx(V,{count:6}):i?e.jsx("div",{className:a.errorText,children:"Failed to load metrics."}):e.jsxs("table",{className:a.metricsTable,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Field"}),e.jsx("th",{children:"Value"})]})}),e.jsx("tbody",{children:Object.entries(s||{}).sort((r,t)=>r[0].localeCompare(t[0])).map(([r,t])=>e.jsxs("tr",{children:[e.jsx("td",{className:a.keyCell,children:r}),e.jsx("td",{className:a.valCell,children:typeof t=="number"?ze(t):String(t)})]},r))})]})})]}),He=({loading:s})=>{const{t:l}=le();return e.jsxs("div",{className:a.chartCard,children:[e.jsx("h3",{children:l("stockDetails.chart")}),e.jsxs("div",{className:a.chartPlaceholder,children:["(",l("stockDetails.chartPlaceholder"),")"]})]})};function Y(s,l){for(const i of l){const r=s==null?void 0:s[i];if(typeof r=="number"&&Number.isFinite(r))return r}return null}function J(s){return Math.abs(s)>=100?s.toFixed(0):s.toFixed(2)}function K(s){return typeof s=="number"&&Number.isFinite(s)}function Ye(s){const l=[],i=[],r=[],t=Y(s,["peTTM","peInclExtraTTM","peExclExtraTTM","peBasicExclExtraTTM"]);K(t)&&t>0&&t<10&&l.push(`Low P/E ${J(t)} — potential undervaluation.`);const f=Y(s,["psTTM","psAnnual"]);K(f)&&f<1&&l.push(`P/S ${J(f)} < 1 — inexpensive sales.`);const o=Y(s,["pb","priceToBookAnnual"]);K(o)&&o<1&&l.push(`P/B ${J(o)} < 1 — trades below book value.`);const h=Y(s,["grossMarginTTM","grossMarginAnnual"]);K(h)&&l.push(`Gross margin ${J(h)}% — indicative of pricing power.`);const m=Y(s,["currentRatioTTM","currentRatioAnnual"]);K(m)&&m>=1.5&&l.push(`Current ratio ${J(m)} — comfortable liquidity.`);const n=Y(s,["netProfitMarginTTM","netMarginAnnual"]);K(n)&&n<0&&i.push(`Net margin ${J(n)}% — loss-making on a TTM basis.`);const v=Y(s,["debtToEquityTTM","debtToEquityAnnual"]);return K(v)&&v>1&&i.push(`Debt/Equity ${J(v)} — elevated leverage.`),!l.length&&!i.length&&r.push("Not enough metrics for a definitive view."),{strengths:l,risks:i,notes:r}}const oe=s=>{const l=typeof s=="number"?s:Number(s);return Number.isFinite(l)?l:null};function z(s,l){if(!s)return null;for(const i of l){const r=oe(s[i]);if(r!==null)return r}return null}function Je(s){return s==="large"?{pe:{low:12,base:16,high:22},pfcf:{low:12,base:16,high:22},ps:{low:1,base:1.5,high:2},pb:{low:1,base:1.4,high:1.9}}:s==="mid"?{pe:{low:10,base:14,high:18},pfcf:{low:10,base:14,high:18},ps:{low:.8,base:1.2,high:1.6},pb:{low:.8,base:1.2,high:1.6}}:{pe:{low:8,base:12,high:16},pfcf:{low:8,base:12,high:16},ps:{low:.5,base:1,high:1.5},pb:{low:.7,base:1,high:1.3}}}function Q(s){return s==null?null:Math.round(s*100)/100}function Ke(s){var Z,H;const l=[],i=s.metric??{},r=oe(s.price),t=Math.max(0,Math.min(.9,((Z=s.options)==null?void 0:Z.marginOfSafety)??.3)),f=Math.max(1,Math.min(20,((H=s.options)==null?void 0:H.riskCapMultiple)??5));if(r==null||r<=0)return{blended:null,methods:[],mos:{threshold:t,pass:null},warnings:["Price is missing — cannot compute valuation."],altCalcs:[],compositeAverage:null};const o=s.category??null,h=Je(o),m=z(i,["peTTM","peInclExtraTTM","peExclExtraTTM","peBasicExclExtraTTM"]),n=z(i,["psTTM","psAnnual"]),v=z(i,["pb","priceToBookAnnual","ptbvQuarterly","ptbvAnnual"]),c=z(i,["pfcfShareTTM","pfcfShareAnnual"]),p=z(i,["netProfitMarginTTM","netMarginAnnual","netProfitMargin5Y"]),w=z(i,["roeTTM","roeAnnual"]),$=z(i,["revenueGrowthTTMYoy","revenueGrowthQuarterlyYoy"]),u=z(i,["52WeekPriceReturnDaily","yearToDatePriceReturnDaily"]),_=z(i,["beta"]);let E=!1;const b={pe:{...h.pe},pfcf:{...h.pfcf},ps:{...h.ps},pb:{...h.pb}};p!=null&&p<0&&(b.pe.low*=.5,b.pe.base*=.5,b.pe.high*=.5,b.pfcf.low*=.5,b.pfcf.base*=.5,b.pfcf.high*=.5,l.push("Negative net margin — downshifted PE/PFCF targets.")),w!=null&&w<5&&(b.pb.low*=.7,b.pb.base*=.7,b.pb.high*=.7,l.push("Low ROE — downshifted PB targets.")),$!=null&&$<0&&(b.ps.low*=.75,b.ps.base*=.75,b.ps.high*=.75,l.push("Negative revenue growth — downshifted PS targets.")),(u!=null&&u<=-90||_!=null&&_>2.2)&&(E=!0,l.push("High-risk profile (52w drawdown or high beta)."));const N=(x,O)=>x==null||!Number.isFinite(x)||x<=0?null:Q(r*(O/x)),d=[m!=null?{key:"pe",available:!0,low:N(m,b.pe.low),base:N(m,b.pe.base),high:N(m,b.pe.high)}:{key:"pe",available:!1},c!=null?{key:"pfcf",available:!0,low:N(c,b.pfcf.low),base:N(c,b.pfcf.base),high:N(c,b.pfcf.high)}:{key:"pfcf",available:!1},n!=null?{key:"ps",available:!0,low:N(n,b.ps.low),base:N(n,b.ps.base),high:N(n,b.ps.high)}:{key:"ps",available:!1},v!=null?{key:"pb",available:!0,low:N(v,b.pb.low),base:N(v,b.pb.base),high:N(v,b.pb.high)}:{key:"pb",available:!1}],j=Object.fromEntries(d.map(x=>[x.key,x.available]));let y={};j.pfcf&&j.pe?y={pfcf:.45,pe:.3,pb:.15,ps:.1}:j.pfcf&&!j.pe?y={pfcf:.6,ps:.25,pb:.15}:!j.pfcf&&j.pe?y={pe:.55,pb:.3,ps:.15}:(j.ps||j.pb)&&(y={ps:.6,pb:.4});let I=0;for(const x of Object.keys(y))j[x]?I+=y[x]:delete y[x];for(const x of Object.keys(y))y[x]=y[x]/I;const D=x=>{if(!I)return null;let O=0;for(const C of d){if(!C.available||C[x]==null)continue;const L=y[C.key]??0;O+=C[x]*L}return Q(O)};let M={low:D("low"),base:D("base"),high:D("high")};const F=x=>{const O=d.filter(L=>L.available&&L[x]!=null).map(L=>L[x]);if(!O.length)return null;const C=O.reduce((L,ce)=>L+ce,0)/O.length;return Q(C)},q=()=>F("low");d.find(x=>x.key==="pe");const k=d.find(x=>x.key==="ps"),S=d.find(x=>x.key==="pb"),A=[];A.push({key:"blend",label:"Multiples Blend (cap-size targets)",source:"Price × (TargetMultiple / CurrentMultiple) blended across P/FCF, P/E, P/S, P/B; targets by market-cap band with risk downshifts and sanity cap.",available:M.base!=null,low:M.low,base:M.base,high:M.high}),A.push({key:"equal_weight",label:"Equal-Weight Multiples",source:"Average of Price × (Target/Current) across available multiples (PE, PFCF, PS, PB).",available:F("base")!=null,low:F("low"),base:F("base"),high:F("high")});const g=q();if(A.push({key:"downside",label:"Downside (Low Targets)",source:"Average of *low* target prices across available multiples; conservative case.",available:g!=null,low:g,base:g,high:g}),A.push({key:"pb_only",label:"PB-only (ROE-tuned)",source:"Price × (TargetPB / CurrentPB), with TargetPB reduced when ROE < 5%.",available:!!(S!=null&&S.available&&S.base!=null),low:(S==null?void 0:S.low)??null,base:(S==null?void 0:S.base)??null,high:(S==null?void 0:S.high)??null}),A.push({key:"ps_only",label:"PS-only (Margin-tuned)",source:"Price × (TargetPS / CurrentPS), with TargetPS reduced when margins/growth are weak.",available:!!(k!=null&&k.available&&k.base!=null),low:(k==null?void 0:k.low)??null,base:(k==null?void 0:k.base)??null,high:(k==null?void 0:k.high)??null}),E){const x=C=>{if(C==null)return null;const L=r*f;return C>L?Q(L):C};M=(C=>({low:x(C.low),base:x(C.base),high:x(C.high)}))(M);for(const C of A)C.low=x(C.low),C.base=x(C.base),C.high=x(C.high);l.push(`High-risk sanity cap applied at ×${f} of current price.`)}const P=M.base!=null?r<=M.base*(1-t):null,B=A.filter(x=>x.available&&x.base!=null).map(x=>x.base),se=B.length?Q(B.reduce((x,O)=>x+O,0)/B.length):null;return{blended:M,methods:d,mos:{threshold:t,pass:P},warnings:l,altCalcs:A,compositeAverage:se}}function Qe(s,l){const i=(s||"").toUpperCase(),r=X(v=>v.stocks.items.find(c=>c.ticker===i)),t=X(re(i)),[f,o]=T.useState(null),[h,m]=T.useState(!1),n=T.useMemo(()=>{const v=[f,l,t==null?void 0:t.price,r==null?void 0:r.price,r==null?void 0:r.prevClose,r==null?void 0:r.open,r==null?void 0:r.high,r==null?void 0:r.low];for(const c of v)if(typeof c=="number"&&Number.isFinite(c)&&c>0)return c;return null},[f,l,t==null?void 0:t.price,r==null?void 0:r.price,r==null?void 0:r.prevClose,r==null?void 0:r.open,r==null?void 0:r.high,r==null?void 0:r.low]);return T.useEffect(()=>{let v=!1;return(async()=>{var c;if(!(n!=null||h||!i))try{m(!0);const p=await ee(`/api/fh/snapshot-batch?symbols=${encodeURIComponent(i)}`,{noStore:!0,timeoutMs:12e3}),w=((c=p==null?void 0:p.items)==null?void 0:c[0])||{},$=[w.price,w.prevClose,w.open,w.high,w.low].find(u=>typeof u=="number"&&Number.isFinite(u)&&u>0);!v&&typeof $=="number"&&o($)}catch{}finally{v||m(!1)}})(),()=>{v=!0}},[n,h,i]),{priceNow:n,fetchingPrice:h,stock:r,seed:t}}const te={};function Xe(s){let l=2166136261;for(let i=0;i<s.length;i++)l^=s.charCodeAt(i),l=Math.imul(l,16777619);return(l>>>0).toString(16)}const Ze=360*60*1e3,ne=typeof import.meta<"u"&&(te==null?void 0:te.VITE_DISABLE_GPT)==="1",es=({symbol:s,priceNow:l,category:i,metric:r,valuation:t})=>{const[f,o]=T.useState(!1),[h,m]=T.useState(!1),[n,v]=T.useState(null),[c,p]=T.useState(null);function w(u){return u.includes("OPENAI_API_KEY not set")?"ChatGPT не настроен: добавьте OPENAI_API_KEY в переменные окружения сервера и перезапустите.":/429/.test(u)&&/quota/i.test(u)?"ChatGPT: исчерпана квота аккаунта OpenAI (нужна оплата/кредиты в Billing).":/429/.test(u)?"ChatGPT: слишком часто. Запрос ограничен со стороны сервера.":u}async function $(){if(!h){m(!0),v(null);try{if(ne)throw new Error("ChatGPT временно отключён админ-флагом (VITE_DISABLE_GPT=1).");const u=r||{},_={pe:u.peTTM??u.peInclExtraTTM??u.peExclExtraTTM??null,pfcf:u.pfcfShareTTM??u.pfcfShareAnnual??null,ps:u.psTTM??u.psAnnual??null,pb:u.pb??u.ptbvQuarterly??u.ptbvAnnual??null,grossMargin:u.grossMarginTTM??null,netMargin:u.netProfitMarginTTM??null,roe:u.roeTTM??null,roic:u.roicTTM??null,revGyoy:u.revenueGrowthTTMYoy??null,beta:u.beta??null,debtToEquity:u.debtToEquityTTM??u.debtToEquityAnnual??null,currentRatio:u.currentRatioTTM??u.currentRatioAnnual??null},E={symbol:s,priceNow:l,category:i,metric:_,valuation:{blended:t.blended,compositeAverage:t.compositeAverage,altCalcs:t.altCalcs.map(M=>({label:M.label,low:M.low??null,base:M.base??null,high:M.high??null})),warnings:t.warnings}},b=`LLM:${s}:${Xe(JSON.stringify({s,p:l,c:i,m:_,v:E.valuation}))}`,N=window.sessionStorage,d=N.getItem(b);if(d){const M=JSON.parse(d);if(M.exp>Date.now()&&M.text){p(M.text),o(!0),m(!1);return}else N.removeItem(b)}const j=await fetch("/api/llm/commentary",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(E)}),y=await j.text().catch(()=>"");if(!j.ok)throw new Error(`${j.status} ${j.statusText}${y?` — ${y}`:""}`);const{commentary:I}=JSON.parse(y),D=I||"No commentary received.";p(D),N.setItem(b,JSON.stringify({text:D,exp:Date.now()+Ze})),o(!0)}catch(u){v(w(String((u==null?void 0:u.message)||u)))}finally{m(!1)}}}return e.jsxs("div",{style:{marginTop:12},children:[e.jsx("button",{className:a.viewButton,style:{padding:"0.45rem 0.9rem"},onClick:$,disabled:h,title:ne?"ChatGPT отключён (env flag)":"Отправить текущие метрики и оценки в ChatGPT для комментария",children:h?"Asking ChatGPT…":ne?"ChatGPT disabled":"Show ChatGPT commentary"}),n?e.jsxs("p",{className:a.errorText,style:{marginTop:8},children:["ChatGPT error: ",n]}):null,f&&c?e.jsxs("div",{className:a.rawTableWrap,style:{marginTop:8,padding:12},children:[e.jsx("div",{className:a.muted,style:{marginBottom:6},children:"AI commentary (not investment advice):"}),e.jsx("div",{style:{whiteSpace:"pre-wrap",lineHeight:1.4},children:c})]}):null]})};function W(s){return s==null||!Number.isFinite(s)?"—":`$${s.toFixed(2)}`}const ss=({symbol:s,metric:l,metricsLoading:i,priceSeed:r})=>{var y,I,D,M,F,q,k,S,A;const{priceNow:t,fetchingPrice:f,stock:o,seed:h}=Qe(s,r),m=(h==null?void 0:h.category)??(o==null?void 0:o.category)??null,[n,v]=T.useState(!1),[c,p]=T.useState(null),[w,$]=T.useState(null),u=T.useMemo(()=>i?"Metrics are still loading…":l?t==null?f?"Fetching price snapshot…":"No price/OHLC snapshot yet":null:"Metrics not loaded yet",[i,l,t,f]),_=!u,E=T.useCallback(()=>{if(!(!_||n)){v(!0),$(null);try{const g=Ke({price:t,category:m,metric:l,options:{marginOfSafety:.3,riskCapMultiple:5}});p(g)}catch(g){$(String((g==null?void 0:g.message)||g)),p(null)}finally{v(!1)}}},[_,n,t,m,l]),b=T.useMemo(()=>{var B;if(!((B=c==null?void 0:c.blended)!=null&&B.base)||!t)return"—";const g=(c.blended.base-t)/t,P=Math.abs(g*100).toFixed(2)+"%";return g>=0?`Discount ${P}`:`Premium ${P}`},[(y=c==null?void 0:c.blended)==null?void 0:y.base,t]),N=T.useMemo(()=>{if(!(c!=null&&c.compositeAverage)||!t)return"—";const g=(c.compositeAverage-t)/t,P=Math.abs(g*100).toFixed(2)+"%";return g>=0?`Discount ${P}`:`Premium ${P}`},[c==null?void 0:c.compositeAverage,t]),d=t?t*5:null,j=g=>d!=null&&typeof g=="number"&&Math.abs(g-d)<.005;return e.jsxs("div",{className:a.fvCard,children:[e.jsxs("div",{className:a.fvHeader,children:[e.jsx("h4",{className:a.fvTitle,children:"Fair Value (ratio-based)"}),e.jsx("button",{onClick:E,disabled:!_||n,className:a.viewButton,style:{padding:"0.45rem 0.9rem"},title:_?"Compare Fair Value with current price":u??"",children:n?"Computing…":"Compare Fair Value"})]}),!_&&e.jsx("p",{className:a.muted,style:{marginTop:4},children:u}),!c&&!w&&_&&e.jsx("p",{className:a.muted,children:"Uses current multiples (P/E, P/FCF, P/S, P/B) → target ranges by size band with risk downshifts & sanity caps."}),w?e.jsxs("p",{className:a.errorText,children:["Valuation error: ",w]}):null,c?e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:a.muted,style:{marginTop:4},children:[e.jsx("strong",{children:"Source:"})," Price × (TargetMultiple / CurrentMultiple), blended across available multiples; targets depend on market-cap band; risk downshifts (neg. margin, low ROE, neg. growth) and a high-risk sanity cap."]}),e.jsxs("div",{className:a.fvGrid,children:[e.jsxs("div",{className:a.kpi,children:[e.jsx("div",{className:a.kpiTitle,children:"Price (now)"}),e.jsx("div",{className:a.kpiValue,children:W(t)})]}),e.jsxs("div",{className:a.kpi,children:[e.jsx("div",{className:a.kpiTitle,children:"Fair Value (base)"}),e.jsxs("div",{className:a.kpiValue,children:[W(((I=c.blended)==null?void 0:I.base)??null),j((D=c.blended)==null?void 0:D.base)?" (capped ×5)":""]}),((M=c.blended)==null?void 0:M.low)!=null&&((F=c.blended)==null?void 0:F.high)!=null?e.jsxs("div",{className:a.kpiSub,children:["Low ",W(c.blended.low)," · High ",W(c.blended.high)]}):null]}),e.jsxs("div",{className:a.kpi,children:[e.jsx("div",{className:a.kpiTitle,children:"Discount / Premium"}),e.jsx("div",{className:a.kpiValue,children:b})]}),e.jsxs("div",{className:a.kpi,children:[e.jsx("div",{className:a.kpiTitle,children:"MoS (30%) Pass"}),e.jsx("div",{className:a.kpiValue,children:((q=c.mos)==null?void 0:q.pass)==null?"—":c.mos.pass?"YES":"NO"}),((k=c.mos)==null?void 0:k.threshold)!=null&&((S=c.blended)==null?void 0:S.base)!=null?e.jsxs("div",{className:a.kpiSub,children:["Threshold: ",W(c.blended.base*(1-c.mos.threshold))]}):null]})]}),e.jsxs("details",{className:a.rawBlock,open:!0,children:[e.jsx("summary",{className:a.rawSummary,children:"Calculators (side-by-side)"}),e.jsx("div",{className:a.rawTableWrap,children:e.jsxs("table",{className:a.metricsTable,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Calculator"}),e.jsx("th",{children:"Low"}),e.jsx("th",{children:"Base"}),e.jsx("th",{children:"High"}),e.jsx("th",{children:"Source"})]})}),e.jsx("tbody",{children:c.altCalcs.map((g,P)=>e.jsxs("tr",{children:[e.jsx("td",{className:a.keyCell,children:g.label}),e.jsx("td",{className:a.valCell,children:W(g.low??null)}),e.jsxs("td",{className:a.valCell,children:[W(g.base??null),j(g.base??null)?" (capped ×5)":""]}),e.jsx("td",{className:a.valCell,children:W(g.high??null)}),e.jsx("td",{className:a.valCell,children:e.jsx("span",{className:a.muted,children:g.source})})]},P))})]})})]}),e.jsxs("div",{className:a.fvGrid,style:{marginTop:8},children:[e.jsxs("div",{className:a.kpi,children:[e.jsx("div",{className:a.kpiTitle,children:"Composite Average (across calculators)"}),e.jsx("div",{className:a.kpiValue,children:W(c.compositeAverage)})]}),e.jsxs("div",{className:a.kpi,children:[e.jsx("div",{className:a.kpiTitle,children:"Discount / Premium vs Average"}),e.jsx("div",{className:a.kpiValue,children:N})]})]}),(A=c.warnings)!=null&&A.length?e.jsxs("details",{className:a.rawBlock,open:!0,children:[e.jsx("summary",{className:a.rawSummary,children:"Warnings & assumptions"}),e.jsx("ul",{style:{margin:"0.25rem 0 0 1rem"},children:c.warnings.map((g,P)=>e.jsxs("li",{className:a.muted,children:["• ",g]},P))})]}):null,e.jsx(es,{symbol:s,priceNow:t,category:m,metric:l,valuation:c})]}):null]})},ts=({symbol:s,metric:l,metricsLoading:i,priceSeed:r})=>{const t=l?Ye(l):null;return e.jsxs("div",{className:a.aboutCard,children:[e.jsx("h3",{children:"About the Company"}),e.jsx("p",{style:{opacity:.8},children:"No long description available."}),t?e.jsxs("div",{style:{marginTop:"0.5rem"},children:[!!t.strengths.length&&e.jsx("ul",{style:{margin:"0.25rem 0"},children:t.strengths.map((f,o)=>e.jsxs("li",{children:["✅ ",f]},"s"+o))}),!!t.risks.length&&e.jsx("ul",{style:{margin:"0.25rem 0"},children:t.risks.map((f,o)=>e.jsxs("li",{children:["⚠️ ",f]},"r"+o))}),!!t.notes.length&&e.jsx("p",{style:{marginTop:6},children:t.notes.join(" ")})]}):null,e.jsx(ss,{symbol:s,metric:l,metricsLoading:i,priceSeed:r})]})};function ns({symbol:s}){var t,f,o,h;const l=ie(),i=X(de(s)),r=T.useCallback(()=>{l(ae({symbol:s,lookbackDays:14,limit:20}))},[l,s]);return e.jsxs("div",{style:{background:"var(--card-bg, #fff)",borderRadius:12,boxShadow:"var(--shadow, 0 2px 12px rgba(0,0,0,.08))",padding:16},children:[e.jsxs("div",{style:{display:"flex",alignItems:"baseline",gap:8},children:[e.jsx("h3",{style:{margin:0,fontSize:18,fontWeight:600},children:"Key Insights (last 14 days)"}),e.jsx("button",{onClick:r,disabled:i.status==="loading",style:{marginLeft:"auto",padding:"6px 10px",borderRadius:8,border:"1px solid var(--border, #ddd)",background:"transparent",cursor:i.status==="loading"?"not-allowed":"pointer"},"aria-busy":i.status==="loading",children:i.status==="loading"?"Loading…":"Refresh"})]}),e.jsx("div",{style:{marginTop:8},children:i.status==="loading"&&!((t=i.items)!=null&&t.length)?e.jsx(V,{count:3,height:14,style:{marginBottom:6}}):(f=i==null?void 0:i.insights)!=null&&f.length?e.jsx("ul",{style:{margin:"8px 0 0",paddingLeft:18},children:i.insights.slice(0,7).map((m,n)=>e.jsx("li",{style:{marginBottom:6},children:m},n))}):e.jsx("div",{style:{color:"var(--muted, #666)",fontSize:14},children:"No key insights available."})}),e.jsx("h4",{style:{marginTop:16,marginBottom:8,fontSize:16,fontWeight:600},children:"Headlines"}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:8},children:i.status==="loading"&&!((o=i.items)!=null&&o.length)?e.jsxs(e.Fragment,{children:[e.jsx(V,{height:18}),e.jsx(V,{height:18}),e.jsx(V,{height:18})]}):(h=i.items)!=null&&h.length?i.items.slice(0,20).map(m=>{var n;return e.jsxs("a",{href:m.url,target:"_blank",rel:"noreferrer noopener",style:{textDecoration:"none",border:"1px solid var(--border, #eee)",borderRadius:10,padding:10},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx("span",{style:{fontSize:12,padding:"2px 6px",borderRadius:6,border:"1px solid #ddd",textTransform:"capitalize"},children:m.sentiment}),(n=m.tags)!=null&&n.length?e.jsx("span",{style:{fontSize:12,color:"var(--muted, #666)"},children:m.tags.join(" · ")}):null,e.jsx("span",{style:{marginLeft:"auto",fontSize:12,color:"var(--muted, #666)"},children:new Date(m.publishedAt).toLocaleString()})]}),e.jsx("div",{style:{marginTop:6,fontWeight:600},children:m.title}),e.jsx("div",{style:{marginTop:4,fontSize:12,color:"var(--muted, #666)"},children:m.source})]},m.id)}):e.jsx("div",{style:{color:"var(--muted, #666)",fontSize:14},children:"No recent headlines."})}),i.status==="failed"&&i.error?e.jsxs("div",{style:{marginTop:10,color:"#b00020"},children:["Error: ",i.error]}):null]})}const as=()=>{var N;const{t:s}=le(),{ticker:l}=ue(),i=he(),r=ie(),t=(l||"").toUpperCase(),f=X(d=>d.stocks.items.find(j=>j.ticker===t)),o=X(re(t)),h=(N=i.state)==null?void 0:N.seed,m=(h==null?void 0:h.price)??(o==null?void 0:o.price)??(f==null?void 0:f.price)??null,n=(h==null?void 0:h.category)??(o==null?void 0:o.category)??(f==null?void 0:f.category)??null;T.useEffect(()=>{t&&r(pe({ticker:t}))},[t,r]);const{loading:v,error:c,metric:p}=Ge(t),{loading:w,error:$,profile:u}=Oe(t),{error:_,facts:E}=Le(t),b=T.useMemo(()=>{const d=((u==null?void 0:u.name)??"").trim(),j=((f==null?void 0:f.name)??"").trim(),y=((E==null?void 0:E.entityName)??"").trim();return d||j||y||null},[u==null?void 0:u.name,f==null?void 0:f.name,E==null?void 0:E.entityName]);return T.useEffect(()=>{t&&r(ae({symbol:t,lookbackDays:14,limit:20}))},[t,r]),e.jsxs(fe.div,{className:a.wrapper,initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:[e.jsx("h1",{className:a.title,children:t?`${b??s("stockDetails.namePlaceholder")} (${t})`:e.jsx(V,{width:300})}),e.jsxs("div",{className:a.grid,children:[e.jsx(qe,{symbol:t,priceSeed:m,categorySeed:n,metric:p,metricsLoading:v,metricsError:c,p2:u,p2Loading:w,p2Error:$,secFacts:E,secError:_}),e.jsxs("div",{children:[e.jsx(He,{}),e.jsx("div",{style:{marginTop:16},children:e.jsx(ns,{symbol:t})})]})]}),e.jsx(We,{metric:p,loading:v,error:c}),e.jsx(ts,{symbol:t,metric:p,metricsLoading:v,priceSeed:m})]})};export{as as StockDetails,as as default};
